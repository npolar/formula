!function(){"use strict";angular.module("formula",[])}(),function(){"use strict";angular.module("formula").directive("formulaField",["$compile","formulaClassService",function(e,t){return{restrict:"AE",scope:{field:"="},link:function(i,n,r){var a=i.field;if(!a.hidden&&a.template){var l=i.$new(),o=angular.element(a.template);l.field=a,o.addClass(t.pathClass(a)),o.addClass(t.schemaClass(a)),e(o)(l,function(e,t){n.append(e)})}}}}])}(),function(){"use strict";angular.module("formula").directive("formulaFields",["$compile","formulaClassService",function(e,t){return{restrict:"AE",scope:{fields:"="},compile:function(i,n){if(i.html()){var r=i.html();i.empty()}return function(i,n,a){i.fields.forEach(function(a){if(!a.hidden&&a.template){var l=i.$new(),o=angular.element(r||a.template);l.field=a,l.parent=a.parents[a.parents.length-1],o.addClass(t.pathClass(a)),o.addClass(t.schemaClass(a)),e(o)(l,function(e,t){n.append(e)})}})}}}}])}(),function(){"use strict";angular.module("formula").directive("formulaFieldsets",["$compile","formulaClassService",function(e,t){return{restrict:"AE",link:function(i,n,r){i.form.fieldsets.forEach(function(r){if(!r.hidden&&r.template){var a=i.$new(),l=angular.element(r.template);a.fieldset=r,l.addClass(t.schemaClass(r)),e(l)(a,function(e,t){n.append(e)})}})}}}])}(),function(){"use strict";angular.module("formula").directive("formula",["$compile","$timeout","formulaI18n","formulaClassService",function(e,t,i,n){return{restrict:"AE",scope:{options:"="},controller:["$scope",function(e){if(!e.options)throw"No formula options provided!";var n={setLanguage:function(t){e.language=t,this.form&&this.form.translate()},setForm:function(t){e.form=this.form=t},updateTemplates:function(){this.form&&(this.form.updateTemplates(),t())},updateTemplate:function(e){this.form&&(this.form.updateTemplate(e),t())}};n.setForm(e.options.form),n.setLanguage(i.code),e.options.controller=n}],link:function(i,r,a){i.$watch("form",function(a){if(a){r.addClass(n.schemaClass(a)),r.html(a.template),e(r.contents())(i);var l,o=i.$watch(function(){clearTimeout(l),l=setTimeout(function(){o(),t(function(){i.form.ready=!0},100)},50)})}})}}}])}(),function(){"use strict";angular.module("formula").directive("formulaInput",["$compile",function(e){var t=function(e,t,i){var n;switch(t.sub){case"textarea":n=angular.element("<textarea>"),n.attr("md-detect-hidden",!0);break;case"select":n=angular.element("<select>"),i.children().length?angular.forEach(i.children(),function(e){n.append(e)}):n.attr("ng-options","value.id as value.label for value in field.values"),e.multiple&&n.attr("multiple","multiple");break;default:switch(n=angular.element("<input>"),n.attr("type",t.sub),t.sub){case"number":case"range":null!==e.step&&n.attr("step",e.step);break;case"any":case"date":case"datetime":case"time":n.attr("type","text")}}return n},i=function(e){var t=e.type?e.type.split(":"):null;return t=t?{main:t[0],sub:t[1]}:null},n=function(e){e.$set("id","{{field.uid}}"),e.$set("ngModel","field.value"),e.$set("ng-disabled","field.disabled"),e.$set("ng-readonly","field.readonly")},r=function(e,n,r){var a=e.field,l=i(a),o=t(a,l,n);return angular.forEach(r,function(e,t){r.$attr[t]&&o.attr(r.$attr[t],e)}),o};return{restrict:"AE",scope:{field:"="},compile:function(t,i,a){return function(t,i,a){n(a);var l=r(t,i,a);l.removeAttr("formula:input"),e(l)(t,function(e,t){i.replaceWith(e)})}}}}])}(),function(){"use strict";angular.module("formula").factory("formulaField",["$filter","$rootScope","formulaI18n","formulaFormat","formulaFieldAttributesService","formulaFieldValidateService","formulaFieldValueFromModelService",function(e,t,i,n,r,a,l){function o(e,t,i,n,a){return"object"==typeof e&&r.attrsSet(this,{schema:e,id:t,parents:i,fieldDefinition:n,index:a}),this}var s=function(e){return"string"==typeof e&&"!"===e.charAt(0)},u=function(e,t){return e+(t.hidden?0:1)};return o.uids=[],o.prototype={dirtyParents:function(){for(var e=this.parents.length-1;e>=0;e--)this.parents[e].dirty=!0,this.parents[e].itemChange(this)},fieldAdd:function(){var e,t=this.parents.slice();if(t.push(this),this.fields||(this.fields=[]),this.typeOf("array")){var i=/\/([^\/]*?)$/.exec(this.path)[1]+"_"+(this.schema.items.type||"any"),n={id:i};n.fields=this.fieldDefinition.fields||null;var r=this.schema.items;e=new o(r,i,t,n),"function"==typeof e.destroyWatcher&&e.destroyWatcher(),e.type&&(e.setRequired(this.schema.required),e.index=this.fields.length,this.fields.push(e))}else this.typeOf("object")&&Object.keys(this.schema.properties).forEach(function(e){var i,n=this.schema.properties[e];if(this.fieldDefinition.fields&&this.fieldDefinition.fields.forEach(function(t){var n;n="string"==typeof t?t.replace("!",""):t.id,e===n&&(i=t)}),!s(i)){var r=new o(n,e,t,i);r.type&&(r.setRequired(this.schema.required),this.fields.push(r))}},this)},fieldFromID:function(e){var t=null;return angular.forEach(this.fields,function(i){t||i.id!==e||(t=i)}),t},itemAdd:function(e){if(this.typeOf("array")&&this.fields){var i=this.parents.slice();i.push(this);var n=this.values.length,r=this.fields[0],a=new o(r.schema,r.id,i,r.fieldDefinition,n);return a.type?(this.values.push(a),void 0!==a.value&&this.value.push(a.value),this.dirty=!0,this.dirtyParents(),e!==!0&&t.$emit("revalidate"),a):null}return null},itemIndex:function(e){for(var t in this.fields)if(this.fields[t].id===e)return t;return-1},itemRemove:function(e){this.typeOf("array")&&(this.values.length>e&&(this.values.splice(e,1),this.value.splice(e,1)),this.values.forEach(function(e,t){e.index=t},this),"function"==typeof e.destroyWatcher&&e.destroyWatcher(),this.dirty=!0,this.dirtyParents(),t.$emit("revalidate"))},itemChange:function(e){switch(this.type){case"array:fieldset":case"array:field":this.values&&(this.value=[],this.values.forEach(function(e){void 0!==e.value&&this.value.push(e.value)},this));break;case"object":this.fields&&(this.value={},this.fields.forEach(function(e){void 0!==e.value&&(this.value[e.id]=e.value)},this))}},itemToggle:function(e){this.typeOf("array")&&this.values.length>e&&(this.values[e].visible=!this.values[e].visible)},get path(){var e="#",t=function(e){var t="/";return t+=null!=e.index?e.index:e.id};return this.parents.forEach(function(i){e+=t(i)}),e+=t(this)},typeOf:function(e){if(!this.type||"string"!=typeof this.type)return!1;var t;return e===this.type||e===(t=this.type.split(":"))[0]||e===t[1]},uidGen:function(e){for(var t="formula-",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n=0;(e?e:8)>n;++n)t+=i[Math.floor(Math.random()*i.length)];return-1!==o.uids.indexOf(t)?this.uidGen(e):(this.uid=t,t)},isEmpty:function(){return null==this.value||0===this.value.length},validate:function(e,t){return a.validate(this,{force:e,silent:t})},valueFromModel:function(e){l.valueFromModel(this,e)},nrArrayValues:function(){return this.values?this.values.reduce(u,0):0},setRequired:function(e){this.required=e===!0||e instanceof Array&&-1!==e.indexOf(this.id)},getErrorText:function(t){var n="";if(t.dataPath){var r=Number(t.dataPath.replace(/^\/(\d+).*$/,"$1"))+1;n+=e("formulaReplace")(i.line,{line:r,error:t.message})}else n+=t.message;return n}},o}])}(),function(){"use strict";angular.module("formula").factory("formulaFieldConfig",[function(){var e=function(e){var t=e||[],i=function(e,t){var i=!1;if(t.match)if("function"==typeof t.match)try{t.match.call({},e)&&(i=!0)}catch(n){}else"string"==typeof t.match&&-1!==[e.mainType,e.id,e.path].indexOf(t.match)&&(i=!0);return i};this.getMatchingConfig=function(e){for(var n,r=t.length-1,a=r;a>=0;a--)if(i(e,t[a])){n=t[a];break}return n},this.addConfig=function(e){t.push(e)},this.setConfigs=function(e){t=e},this.isMatch=function(e,t){return i(e,t)}};return{getInstance:function(t){return new e(t)}}}])}(),function(){"use strict";angular.module("formula").factory("formulaForm",["$rootScope","formulaJsonLoader","formulaModel","formulaField","formulaI18n","formulaEvaluateConditionsService","formulaTemplateService",function(e,t,i,n,r,a,l){function o(e,t){if(e&&"object"===e.type){var i=[{fields:[],id:"the-fieldset",mainType:"fieldset"}];return Object.keys(e.properties).forEach(function(r){var a=e.properties[r],l=new n(a,r);l.type&&(l.setRequired(e.required),l.valueFromModel(t),i[0].fields.push(l))}),l.initNode(i[0]),i}return null}function s(t,n,s,f){this.errors=null,this.i18n=r,this.schema=t,this.formDefinition=s,this.title=null,this.valid=!1,this.model=new i(n),this.mainType="form",l.initNode(this),a.keepFailing(!!f),s?(this.title=s.title,this.fieldsets=u(t,s,this.model.data)):this.fieldsets=o(t,this.model.data),this.onsave=function(e){window.open("data:application/json,"+JSON.stringify(e))};var c=this;this.destroyWatcher=e.$on("revalidate",function(){c.validate()}),this.translate(),this.validate(!0,!0)}var u=function(e,t,i){if(e&&"object"===e.type&&t.fieldsets){var r=[];return t.fieldsets.forEach(function(t,a){var o={title:t.title,active:a?!1:!0,fields:[],id:t.title+a,mainType:"fieldset"};t.fields.forEach(function(t,r){var a;a="string"==typeof t?t:t.id;var l=e.properties[a]||{id:a},s=new n(l,a,null,t);s.type&&(s.setRequired(e.required),s.valueFromModel(i),o.fields.push(s))}),l.initNode(o),r.push(o)}),r}return null},f=function(e){var t=[],i=function(e){t.push.apply(t,f(e))};return e.typeOf("array")?(e.fields.forEach(i),e.values.forEach(i)):e.typeOf("object")&&e.fields.forEach(i),t.push(e),t};return s.prototype={updateTemplates:function(){l.initNode(this),this.fieldsets.forEach(l.initNode),this.fields().forEach(l.initNode)},updateTemplate:function(e){l.evalTemplate(this,e),this.fieldsets.forEach(function(t){l.evalTemplate(t,e)}),this.fields().forEach(function(t){l.evalTemplate(t,e)})},fields:function(){var e=[];return this.fieldsets.forEach(function(t){t.fields.forEach(function(t){e.push.apply(e,f(t))})}),e},destroy:function(){this.fields().forEach(function(e){"function"==typeof e.destroyWatcher&&e.destroyWatcher()}),this.destroyWatcher()},activate:function(e){this.fieldsets.forEach(function(t,i){("object"==typeof e||"number"==typeof e)&&(("object"==typeof e?t===e:i===e)?t.active=!0:t.active=!1)})},toggleArrays:function(){this.fieldsets.forEach(function(e){e.fields.forEach(function(e){e.values.forEach(function(t,i){e.itemToggle(i)})})})},save:function(e){if(this.ready=!1,e!==!1&&!this.validate(!0))throw console.warn("Document not vaild",this.errors),this.errors;return"function"==typeof this.onsave?this.onsave(this.model.data):void 0},translate:function(){function e(t,i){var n=i&&i.fields?i.fields[t.id]||null:null;(t.typeOf("array")||t.typeOf("object"))&&(angular.forEach(t.fields,function(t){e(t,n)}),angular.forEach(t.values,function(t){angular.forEach(t.fields,function(t){e(t,n)})})),n?(t.title=n.title||t.title,t.description=n.description||t.description,t.typeOf("select")&&(t.values=[],angular.forEach(t["enum"],function(e,i){t.values.push({id:e,label:n.values?n.values[i]||e:e})}))):t.typeOf("select")&&(t.values=[],angular.forEach(t["enum"],function(e){t.values.push({id:e,label:e})}))}this.fieldsets.forEach(function(t,i){r.fieldsets&&(t.title=r.fieldsets[i]||t.title),t.fields.forEach(function(t){e(t,r)})})},validate:function(e,t){var i=this.errors||[],n=function(r){if(r.typeOf("array")?r.values.forEach(function(e){n(e)}):r.typeOf("object")&&r.fields.forEach(function(e){n(e)}),r.dirty||e){var a;r.validate(e,t)?-1!==(a=i.indexOf(r.path))&&i.splice(a,1):r.typeOf("input")&&(i.push(r.path),i=i.filter(function(e,t,i){return i.indexOf(e)===t}))}};return this.fieldsets.forEach(function(e){e.fields.forEach(function(e){n(e),e.valid?this.model.data[e.id]=e.value:delete this.model.data[e.id]},this)},this),a.evaluateConditions(this),this.errors=i,(this.valid=!this.errors.length)&&(this.errors=null),this.valid}},s}])}(),function(){"use strict";angular.module("formula").factory("formulaFormat",[function(){return{color:function(e,t){var i="aqua,black,blue,fuchsia,gray,green,lime,maroon,navy,olive,orange,purple,red,silver,teal,white,yellow";return"string"!=typeof e||-1===i.split(",").indexOf(e.toLowerCase())&&!/^(#([a-f0-9]{3}|[a-f0-9]{6})|rgb\(\s?\d{1,3}%?,\s?\d{1,3}%?,\s?\d{1,3}%?\s?\))$/i.test(e)?"CSS 2.1 color":null},date:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}$/.test(e)?null:"ISO 8601 date, e.g. 2015-11-30 (year-month-day)"},datetime:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}T\d{2}(:\d{2}){2}(.\d+)?(([+-](\d{2}|\d{4}|\d{2}:\d{2}))|Z)$/.test(e)?null:"ISO 8601 datetime, e.g. 2015-11-30T23:45:30Z"},yearmonth:function(e,t){return"string"==typeof e&&/^\d{4}-\d{2}$/.test(e)?null:"ISO 8601 date without day fraction, e.g. 2016-01 (year-month)"},year:function(e,t){return"string"==typeof e&&/^\d{4}$/.test(e)?null:"ISO 8601 four-digit year, e.g. 2015"},email:function(e,t){var i=/^[-+a-z0-9!#$%&'*=?^_`{|}~\/]([-+a-z0-9!#$%&'*=?^_`{|}~\/]|\.(?!\.)){0,62}[-+a-z0-9!#$%&'*=?^_`{|}~\/]$/i,n=/^[-a-z0-9]([-a-z0-9]|\.(?!\.)){0,253}[-a-z0-9]$/i,r=/\(.*\)/g,a="string"==typeof e?e.split("@"):[];return 2===a.length&&e.length<=254&&i.test(a[0].replace(r,""))&&n.test(a[1].replace(r,""))?null:"RCF 3696 e-mail address"},time:function(e,t){return"string"==typeof e&&/^\d{2}(:\d{2}){2}$/.test(e)?null:"ISO 8601 time, e.g. 23:45:30"},uri:function(e,t){return"string"==typeof e&&/^([a-z][a-z0-9+.-]*):(?:\/\/((?:(?=((?:[a-z0-9-._~!$&'()*+,;=:]|%[0-9A-F]{2})*))(\3)@)?(?=(\[[0-9A-F:.]{2,}\]|(?:[a-z0-9-._~!$&'()*+,;=]|%[0-9A-F]{2})*))\5(?::(?=(\d*))\6)?)(\/(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\8)?|(\/?(?!\/)(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\10)?)(?:\?(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\11)?(?:#(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\12)?$/i.test(e)?null:"RFC 3986 URI"}}}])}(),function(){"use strict";angular.module("formula").factory("formula",["$q","formulaI18n","formulaTemplateService","formulaSchema","formulaJsonLoader","formulaForm",function(e,t,i,n,r,a){var l=function(l){if(!l)throw"No formula options provided!";var o={},s=new n,u=[s.deref(l.schema),r(l.model),r(l.form)];l.templates instanceof Array&&i.setTemplates(l.templates),(l.languages instanceof Array?l.languages:[]).forEach(function(e,i){t.add(e.uri||e.map,e.code,e.aliases).then(function(){0===i&&c(e.code)})});var f=e.all(u).then(function(e){return d(e[1],e[2]),e},function(){console.error("Could not load form",arguments)}),c=function(e){t.set(e).then(function(){o.controller&&o.controller.setLanguage(e)})},d=function(e,t){o.form&&o.form.destroy(),o.form=new a(s.json,e,t,l.keepFailing),o.controller&&(o.controller.setForm(o.form),o.form.translate()),o.form.onsave=l.onsave||o.form.onsave};return this.setModel=function(e){f.then(function(t){d(e,t[2])})},this.setForm=function(t){var i=[f];"string"==typeof t?i.push(r(t)):i.push(Promise.resolve(t)),e.all(i).then(function(e){d(e[0][1],e[1])})},this.setTemplates=function(e){e.setTemplates(e),o.controller&&o.controller.updateTemplates()},this.addTemplate=function(e){i.addTemplate(e),o.controller&&o.controller.updateTemplate(e)},this.setOnSave=function(e){o.form.onsave=e},this.save=function(){return o.form.save()},this.setSchema=function(e){e=new n,f.then(function(e){d(e[1],e[2])})},this.i18n={add:t.add,set:c,get code(){return t.code}},this._cfg=o,this};return{getInstance:function(e){return new l(e)}}}])}(),function(){"use strict";angular.module("formula").factory("formulaI18n",["formulaJsonLoader","formulaLog","$q",function(e,t,i){var n={code:"en",text:{add:{label:"Add",tooltip:"Click to add a new item"},invalid:"{count} invalid fields",maximize:{label:"Maximize",tooltip:"Click to maximize item"},minimize:{label:"Minimize",tooltip:"Click to minimize item"},remove:{label:"Remove",tooltip:"Click to remove item"},required:"Required field",save:{label:"Save",tooltip:"Click to save document"},validate:{label:"Validate",tooltip:"Click to validate form"},line:"Line {line}: {error}"},fields:{},fieldsets:[]},r=n,a={},l={},o=function(e){var t=l[e];return tv4.language(t.replace(/_.*/,"")),a[t]?Promise.resolve(a[t]).then(function(e){r=e,r.code=t}):void 0},s=function(n,r,o){if(!n)return void t.warning(t.codes.I18N_MISSING_URI);if(!r)return void t.warning(t.codes.I18N_MISSING_CODE,{uri:n});var s=i.defer();(o instanceof Array?o:[o]).forEach(function(e){l[e]=r}),l[r]=r;var u=l[r];return a[u]=s.promise,"string"==typeof n?e(n).then(function(e){a[u]={fields:e.fields,fieldsets:e.fieldsets,text:e.text},s.resolve(a[u])}):(a[u]=n,s.resolve(n)),s.promise};return{add:s,set:o,get fields(){return r.fields},get fieldsets(){return r.fieldsets},get text(){return r.text},get code(){return r.code}}}])}(),function(){"use strict";angular.module("formula").factory("formulaJsonLoader",["$http","$q","formulaLog",function(e,t,i){var n;return n=function(r,a,l){var o=t.defer();return"string"!=typeof r?o.resolve(r):(a?e.jsonp(r+"?callback=JSON_CALLBACK"):e.get(r)).success(function(e,t,i,n){o.resolve(e)}).error(function(e,t,l,s){return a?(i.error(i.codes.JSON_LOAD_ERROR,{uri:r}),void o.reject(r)):n(r,!0)}),o.promise}}])}(),function(){"use strict";angular.module("formula").factory("formulaLog",[function(){function e(e,t){var i=e,n=i.match(/\{[^\}]*\}/g);return angular.forEach(n,function(e,n){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}var t={FIELD_INVALID_ID:"field ID contains an illegal character: {character} ({field})",FIELD_MISSING_PROPERTY:"missing required field property: {property} ({field})",FIELD_UNSUPPORTED_FORMAT:"unsupported string format: {format} ({field})",FIELD_UNSUPPORTED_PROPERTY:"unsupported field property: {property} ({field})",FIELD_UNSUPPORTED_TOKEN:"unsupported default token: {token} ({field})",FIELD_UNSUPPORTED_TYPE:"unsupported field type: {type} ({field})",FIELD_HIDDEN_DEFAULT:"field hidden by default: {field}",I18N_MISSING_CODE:"missing language code: {uri}",I18N_MISSING_URI:"missing i18n uri",JSON_LOAD_ERROR:"could not load JSON document: {uri}",SCHEMA_INVALID_URI:"invalid URI for schema deref: {uri}",SCHEMA_MISSING_PROPERTY:"missing required schema property: {property} ({schema})",SCHEMA_MISSING_REFERENCE:"missing schema reference: {schema}",MISSING_TEMPLATE:"missing template for {missing}"};return{codes:t,debug:function(t,i){i?console.debug(e(t,i)):console.debug(t)},error:function(t,i){console.error(e(t,i))},warning:function(t,i){console.warn(e(t,i))}}}])}(),function(){"use strict";angular.module("formula").factory("formulaModel",[function(){function e(e){this.data="object"==typeof e?angular.copy(e):{}}return e}])}(),function(){"use strict";angular.module("formula").factory("formulaSchema",["$q","formulaJsonLoader","formulaLog",function(e,t,i){function n(e){this.deferred=null,this.json=null,this.uri=e||null}return n.cache={},n.prototype={compile:function(){function e(e){if("#"===e[0]){e=e.substr("/"===e[1]?2:1).split("/");var t=r.json;return angular.forEach(e,function(e){t&&(t=t[e])}),t}return null}function t(i,r,a){var l,o=[];return angular.forEach(i,function(s,u){"object"==typeof s?o=o.concat(t(s,i,u)):"$ref"===u&&r&&("#"===s[0]?(l=e(s))?r[a]=l:(o.push(s),delete r[a]):n.cache[s]&&n.cache[s].json?r[a]=n.cache[s].json:(o.push(s),delete r[a]))}),o}var r=this,a=this.json?t(this.json):[this.uri];return a.length?(angular.forEach(a,function(e){i.warning(i.codes.SCHEMA_MISSING_REFERENCE,{schema:e})}),!1):!0},deref:function(r){var a=this;if(this.deferred=e.defer(),r&&"string"==typeof r)if(n.cache[r])n.cache[r].then(function(e){a.json=e,a.deferred.resolve(e)});else{var l={schema:n.cache[r]=new n(r),missing:null,resolve:function(e){if(e&&this.missing instanceof Array){var t=this.missing.indexOf(e);-1!==t&&this.missing.splice(t,1)}this.missing&&this.missing.length||(this.schema.compile(),a.json=this.schema.json,a.deferred.resolve(a.json))}};t(r).then(function(e){l.schema.json=e;var t=l.schema.missing(!1);t?(l.missing=angular.copy(t),angular.forEach(t,function(e){if(n.cache[e])n.cache[e].then(function(){l.resolve(e)});else{var t=new n;t.deref(e).then(function(){l.resolve(e)})}})):l.resolve()},function(e){a.deferred.reject(e)})}else i.warning(i.codes.SCHEMA_INVALID_URI,{uri:r}),this.deferred.reject("Invalid schema URI: "+r);return this},missing:function(e){function t(i){var r=[];return angular.forEach(i,function(i,a){if("object"==typeof i){var l=t(i);angular.forEach(l,function(e){r.push(e)})}else"$ref"===a&&"#"!==i[0]&&(e&&n.cache[i]||r.push(i))}),r}var i=t(this.json);return i.length?i:null},then:function(e){this.deferred?this.deferred.promise.then(function(t){e(t)},function(e){}):e(this.json)}},n}])}(),function(){"use strict";angular.module("formula").filter("formulaInlineValues",[function(){return function(e,t){var i=[];return angular.forEach(e,function(e){if(e.value instanceof Array)i.push("Array["+e.value.length+"]");else switch(typeof e.value){case"string":case"number":case"boolean":i.push(e.value)}}),i.join(", ")}}])}(),function(){"use strict";angular.module("formula").filter("formulaReplace",[function(){return function(e,t){var i=e;return(e.match(/\{[^\}]*\}/g)||[]).forEach(function(e){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}}])}(),function(){"use strict";angular.module("formula").service("formulaClassService",[function(){var e=function(e){var t=e.path;return t=t.replace("#","formula")},t=function(e){var t=e.mainType;return"formula"+t.charAt(0).toUpperCase()+t.slice(1)};return{schemaClass:t,pathClass:e}}])}(),function(){"use strict";angular.module("formula").service("formulaEvaluateConditionsService",["$rootScope",function(e){var t=!0,i=function(e){var t={};e.fieldsets.forEach(function(e){e.fields.forEach(function(e){t[e.id]=e.value})}),e.fields().forEach(function(e){n(e,t)})},n=function(i,n){if(i.condition){var r=!0,a=i.condition instanceof Array?i.condition:[i.condition];a.forEach(function(t){r&&("#"!==t[0]&&(t=i.path.substr(0,i.path.lastIndexOf("/")+1)+t),t=t.substr(2),t=t.replace(/\/(\d+)/g,"[$1]"),t=t.replace(/\//g,"."),t=t.replace("=","==").replace("===","=="),r=e.$eval(t,n))}),i.visible=i.hidden?!1:r,t||(r?i.value=i.backupValue:(i.backupValue=i.value,i.value=void 0))}};return{evaluateConditions:i,keepFailing:function(e){t=e}}}])}(),function(){"use strict";angular.module("formula").service("formulaFieldAttributesService",["$rootScope","formulaLog","formulaTemplateService","formulaFieldTranslateDefaultsService","formulaFieldTypeService",function(e,t,i,n,r){var a=function(e,t){if("object"==typeof e){var i="condition,default,description,disabled,enum,format,hidden,maximum,maxLength,minimum,minLength,multiple,nullable,pattern,readonly,required,step,title,type,values".split(",");angular.forEach(t,function(e,t){-1!==i.indexOf(t)&&(this[t]=e)},e)}},l=function(t){t.typeOf("input")&&(t.destroyWatcher=e.$watch(function(){return t.value},function(i,n){if(i!==n){if(null===t.value||""===t.value)return void(t.value=void 0);t.dirty=!0;for(var r=t.parents.length-1;r>=0;r--)t.parents[r].dirty=!0,t.parents[r].itemChange(t);e.$emit("revalidate")}}))},o=function(e){void 0!==e["default"]?(!e.typeOf("array")||e["default"]instanceof Array||(e["default"]=[e["default"]]),e.value=e["default"]):e.typeOf("array")?e.value=[]:e.typeOf("object")&&(e.value={}),e.typeOf("select")&&!e.multiple&&null==e.value&&(e.value=e["enum"][0])},s=function(e){[".","/","#"].forEach(function(e){this.id&&this.id.indexOf(e)>=0&&t.warning(t.codes.FIELD_INVALID_ID,{character:e,field:this.path})},e)},u=function(e,u){return e.parents=u.parents||[],e.id=e.title=u.id,e.index=u.index,a(e,e.schema=u.schema),a(e,e.fieldDefinition=u.fieldDefinition||{}),s(e),e.uidGen(),n.translateDefaultValues(e),r.setFieldType(e),e.type?(o(e),e.typeOf("array")&&e.schema.items&&e.fieldDefinition.fields&&a(e.items,e.fieldDefinition.fields[0]),(e.typeOf("array")||e.typeOf("object"))&&e.fieldAdd(),e.typeOf("array")&&e.schema.minItems&&e.itemAdd(),e.pattern&&!e.schema.pattern&&(e.schema.pattern=e.pattern),e.id&&"_"===e.id[0]&&e.hidden!==!1&&(t.debug(t.codes.FIELD_HIDDEN_DEFAULT,{field:e.path}),e.hidden=!0),l(e),i.initNode(e),e.visible=e.hidden?!1:!0,e):void 0};return{attrsSet:u}}])}(),function(){"use strict";angular.module("formula").service("formulaFieldTranslateDefaultsService",["$filter","formulaLog",function(e,t){var i=function(i){if("string"==typeof i["default"]){var n,r=i["default"].match(/^%(.*)%$/);if(r){switch(r[1]){case"date":n=e("date")(new Date,"yyyy-MM-dd","UTC");break;case"datetime":n=e("date")(new Date,"yyyy-MM-ddThh:mm:ss","UTC")+"Z";break;case"time":n=e("date")(new Date,"hh:mm:ss","UTC");break;case"year":n=e("date")(new Date,"yyyy","UTC");break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TOKEN,{token:r[1],field:i.path})}n&&(i["default"]=n)}}};return{translateDefaultValues:i}}])}(),function(){"use strict";angular.module("formula").service("formulaFieldTypeService",["$filter","formulaLog","formulaFormat",function(e,t,i){var n=function(e){e.type instanceof Array&&(e.nullable=e.type.some(function(e){return"null"===e}),1===e.type.length?e.type=e.type[0]:2===e.type.length?"null"===e.type[0]?e.type=e.type[1]:"null"===e.type[1]&&(e.type=e.type[0]):(e.types=e.type,e.type="any"))},r=function(e){if(n(e),e.mainType="field","select"===e.type||e["enum"])e.type="input:select",e.values=[],e["enum"].forEach(function(t){e.values.push({id:t,label:t})});else if(e.format){var r=e.format.replace("-","");if(i[r]){switch(r){case"date":case"datetime":case"time":e.type="input:"+r;break;default:e.type="input:text"}tv4.addFormat(e.format,i[r])}else t.warning(t.codes.FIELD_UNSUPPORTED_FORMAT,{format:e.format,field:e.path}),e.type="input:text"}else switch(e.type){case"any":e.type="input:any";break;case"array":if(e.mainType="array",e.values=[],e.schema.items){var a=e.schema.items;"object"===a.type?e.type="array:fieldset":"array"===a.type?e.type="array:array":a["enum"]?(e["enum"]=a["enum"],e.multiple=!0,e.type="input:select",e.mainType="field"):a.allOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"allOf",field:e.path}):a.anyOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"anyOf",field:e.path}):a.oneOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"oneOf",field:e.path}):e.type="array:field",e.schema.minItems>=1&&(e.required=!0)}else t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"items",field:e.path}),e.type=null;break;case"boolean":case"checkbox":e.type="input:checkbox",e.value=!!e.value;break;case"integer":case"number":e.type="input:number";break;case"range":e.type="input:range";break;case"object":e.mainType="object",e.schema.properties||(t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"properties",field:e.path}),e.type=null);break;case"textarea":e.type="input:textarea";break;case"string":case"text":e.type="input:text";break;case void 0:e.type="input:text";break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TYPE,{type:e.type,field:e.path}),e.type=null}};return{setFieldType:r}}])}(),function(){"use strict";angular.module("formula").service("formulaFieldValidateService",[function(){var e=function(e,t){var i=t.silent,n=t.force;if(e.schema){var r;if(!e.dirty&&!n||!e.required&&void 0===e.value||(r=tv4.validateMultiple(e.value,e.schema),e.valid=r.valid),!e.valid&&e.nullable){switch(typeof e.value){case"string":e.value&&e.value.length||(e.value=null);break;case"number":isNaN(e.value)&&(e.value=null);break;case"object":Object.keys(e.value).length||(e.value=null)}e.values&&!e.values.length&&(e.value=null),e.isEmpty()&&(e.valid=!0)}return!i&&r&&e.valid===!1?e.typeOf("array")||e.typeOf("object")?e.errors=r.errors:e.error=r.errors[0]:(e.error=null,e.errors=null),e.dirty=!1,e.valid!==!1}return!1};return{validate:e}}])}(),function(){"use strict";angular.module("formula").service("formulaFieldValueFromModelService",["formulaTemplateService",function(e){var t=function(i,n){void 0!==n[i.id]&&("object"===i.type?i.fields.forEach(function(e,r){void 0!==n[i.id][e.id]&&t(e,n[i.id])}):i.typeOf("array")&&(i.values=[],n[i.id].forEach(function(e,n){var r;if(i.typeOf("fieldset")){if(r=i.itemAdd(!0),0!==r.index&&(r.visible=!1),r){var a={};a[i.values[n].id]=e,t(i.values[n],a)}}else i.typeOf("field")&&(r=i.itemAdd(!0),r&&(i.values[n].value=e))},i)),i.value!==n[i.id]&&(i.value=n[i.id],i.dirty=!0,e.initNode(i)))};return{valueFromModel:t}}])}(),function(){"use strict";angular.module("formula").service("formulaTemplateService",["$templateCache","$templateRequest","$q","formulaLog","formulaFieldConfig",function(e,t,i,n,r){var a=[{match:"field",templateUrl:"formula/default/field.html"},{match:"object",templateUrl:"formula/default/object.html"},{match:"array",templateUrl:"formula/default/array.html"},{match:"fieldset",templateUrl:"formula/default/fieldset.html"},{match:"form",templateUrl:"formula/default/form.html"}],l=r.getInstance(a),o=function(n){var r=e.get(n);if(!r)return t(n,!1);var a=i.defer();return a.resolve(r),a.promise},s=function(e){var t=l.getMatchingConfig(e),n=i.defer();return t?t.hidden||""===t.template?n.resolve(!1):t.template?n.resolve(t.template):t.templateUrl?o(t.templateUrl).then(function(e){n.resolve(e)},function(){n.reject(t.templateUrl)}):n.reject(e.path):n.reject(e.mainType),n.promise},u=function(e){s(e).then(function(t){t?e.template=t:e.hidden=!0},function(t){n.warning(n.codes.MISSING_TEMPLATE,{missing:t}),e.hidden=!0})},f=function(e){l.setConfigs(e)},c=function(e){l.addConfig(e)},d=function(e,t){l.isMatch(e,t)};return{addTemplate:c,setTemplates:f,initNode:u,evalTemplate:d}}])}(),angular.module("formula").run(["$templateCache",function(e){e.put("formula/default/array.html",'<fieldset ng-class="{ valid: field.valid, error: field.errors }"><legend>{{ field.title }} ({{ field.nrArrayValues() || 0 }})</legend><ul ng-if="::field.typeOf(\'fieldset\')"><li ng-repeat="value in field.values track by value.path" ng-if="!value.hidden"><fieldset ng-class="{ valid: value.valid }"><legend><span ng-if="!value.visible">{{ value.fields | formulaInlineValues }}</span> <a class="toggle" href="" ng-click="field.itemToggle($index)" title="{{ value.visible ? form.i18n.text.minimize.tooltip : form.i18n.text.maximize.tooltip }}">{{ value.visible ? \'_\' : \'‾\' }}</a> <a class="remove" href="" ng-click="field.itemRemove($index)" title="{{ form.i18n.text.remove.tooltip }}">&times;</a></legend><formula:field field="value" ng-if="value.visible"></formula:field></fieldset></li><li><span ng-if="field.errors" title="{{ field.errors.join(\'\\n\') }}">{{ form.i18n.text.invalid | formulaReplace : { count: field.errors.length } }}</span> <span ng-if="!field.errors">{{ field.description }}</span> <button class="add" ng-click="field.itemAdd()" title="{{ form.i18n.text.add.tooltip }}" type="button"><strong>&plus;</strong> {{ form.i18n.text.add[0] }}</button></li></ul><ul ng-if="::field.typeOf(\'field\')"><li ng-class="{ valid: value.valid, error: value.error }" ng-repeat="value in field.values track by value.path"><input formula:input="" field="value"> <a class="remove" href="" ng-click="field.itemRemove($index)" title="{{ form.i18n.text.remove.tooltip }}">&times;</a></li><li><span ng-if="field.errors" title="{{ field.errors.join(\'\\n\') }}">{{ form.i18n.text.invalid | formulaReplace : { count: field.errors.length } }}</span> <span ng-if="!field.errors">{{ field.description }}</span> <button class="add" ng-click="field.itemAdd()" title="{{ form.i18n.text.add.tooltip }}" type="button"><strong>&plus;</strong> {{ form.i18n.text.add.label }}</button></li></ul></fieldset>'),e.put("formula/default/field.html",'<div ng-class="{ valid: field.valid, error: field.error, required: (field.required && field.value == null) }" ng-if="field.visible" title="{{ field.description }}"><label for="{{ ::field.uid }}">{{ field.title }} {{field.visibility}}</label><formula:input field="field"></formula:input><span ng-if="field.error">{{ field.getErrorText(field.error) }}</span> <span ng-if="field.description">{{ field.description }}</span></div>'),e.put("formula/default/fieldset.html",'<fieldset ng-show="fieldset.active"><formula:fields fields="::fieldset.fields"></formula:fields></fieldset>'),e.put("formula/default/form.html",'<div><div class="formula" ng-if="!form.ready"><div class="loading"><div class="spinner"></div><span>Loading...</span></div></div><form class="formula" ng-show="form.ready"><header ng-if="::form.title">{{ form.title }}</header><nav ng-if="::form.fieldsets.length > 1"><a href="" ng-class="{ active: fieldset.active }" ng-click="form.activate(fieldset)" ng-repeat="fieldset in ::form.fieldsets track by fieldset.id">{{ fieldset.title }}</a></nav><formula:fieldsets></formula:fieldsets><footer><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ form.i18n.text.invalid | formulaReplace : { count: form.errors.length } }}</span> <button ng-click="form.validate(true);" ng-if="!data.hideButtons" title="{{ form.i18n.text.validate.tooltip }}"><strong>&#10003;</strong> {{ form.i18n.text.validate.label }}</button> <button ng-click="form.save()" ng-disabled="!form.valid" ng-if="!data.hideButtons" title="{{ form.i18n.text.save.tooltip }}"><strong>&#9921;</strong> {{ form.i18n.text.save.label }}</button></footer></form></div>'),
e.put("formula/default/object.html",'<fieldset><legend ng-if="::field.title">{{ field.title }}</legend><formula:fields fields="::field.fields"></formula:fields></fieldset>')}]);