"use strict";angular.module("formula",[]),function(){angular.module("formula").directive("formulaFieldDefinition",function(){return{restrict:"A",require:"^formula",compile:function(e,t){t.$set("formulaFieldDefinition");var i=e.html();return function(e,t,a,n){n.fieldDefinition=i}}}})}(),function(){angular.module("formula").directive("formulaFieldInstance",["$compile",function(e){return{restrict:"AE",require:"^formula",scope:{field:"="},compile:function(){return function(t,i,a,n){var l=angular.element(n.fieldDefinition);e(l)(t,function(e,t){i.prepend(e)})}}}}])}(),function(){angular.module("formula").directive("formulaField",["$compile","$q","formulaModel","formulaEvaluateConditionsService",function(e,t,i,a){var n=function(e,i,a){var n,r=e.field,s=l(r),o=t.defer();switch(s.sub){case"textarea":n=angular.element("<textarea>");break;case"select":n=angular.element("<select>"),i.children().length?angular.forEach(i.children(),function(e){n.append(e)}):n.attr("ng-options","value.id as value.label for value in field.values"),r.multiple&&n.attr("multiple","multiple");break;default:switch(n=angular.element("<input>"),n.attr("type",s.sub),s.sub){case"number":case"range":null!==r.step&&n.attr("step",r.step);break;case"any":case"date":case"datetime":case"time":n.attr("type","text")}}if(angular.forEach(a,function(e,t){a.$attr[t]&&n.attr(a.$attr[t],e)}),"autocomplete"===s.sub){var f=angular.element("<datalist>"),u=r.id+"_list";n=angular.element("<input>"),n.attr("list",u),f.attr("id",u),r.querySearch("").then(function(e){e.forEach(function(e){var t=angular.element("<option>");t.attr("value",e),f.append(t)}),o.resolve(n)}),n.append(f)}else o.resolve(n);return o.promise},l=function(e){var t=e.type?e.type.split(":"):null;return t=t?{main:t[0],sub:t[1]}:null},r=function(e,t){t.$set("id",e.uid),t.$set("ngModel","field.value"),t.$set("formulaField"),e.disabled&&t.$set("disabled","disabled"),e.readonly&&t.$set("readonly","readonly")},s=function(e,t){e.form=t[0].form,e.backupValue=null,t[1]&&(e.field=t[1].field)},o=function(e,t){var i="formula-";angular.forEach(e.parents,function(e){i+=e.id+"/"}),e.id?i+=e.id:e.parents&&(i=i.substr(0,i.length-1)),t.addClass(i)},f=function(e,t){var i=e.schema.type;i&&t.addClass("formula"+i.charAt(0).toUpperCase()+i.slice(1))},u=function(e,i,a,r){var s=t.defer(),o=e.field,f=l(o);if(o.customTemplate){var u=angular.element(o.customTemplate);u.addClass("formulaCustomObject"),s.resolve(u)}else"input"===f.main?n(e,i,a,f).then(function(e){s.resolve(e)}):s.resolve(angular.element(i));return s.promise},d=function(e,t){var i=l(t);"input"===i.main&&e.$watch("field.value",function(i,a){i!==a&&e.form&&(t.dirty=!0,t.parents.forEach(function(e){e.dirty=!0}),e.form.validate())})};return{restrict:"A",require:["^formula","?^formulaFieldInstance"],scope:{field:"=formulaField"},link:function(t,i,n,l){var c=t.field;s(t,l),r(c,n),u(t,i,n,l).then(function(a){o(c,a),f(c,a),e(a)(t,function(e,t){i.replaceWith(e)})}),d(t,c),a.evaluateConditions(t,c)},terminal:!0}}])}(),function(){angular.module("formula").directive("formula",["formulaJsonLoader","formulaModel","formulaSchema","formulaForm","formulaI18n","formulaCustomTemplateService","$http","$compile","$templateCache","$templateRequest","$q",function(e,t,i,a,n,l,r,s,o,f,u){return{restrict:"A",scope:{data:"=formula"},controller:["$scope","$attrs","$element",function(r,d,c){function h(e){return u(function(t,i){var a,n,l="formula/",r="default.html";e=e||r,".html"!==e.substr(-5)&&(e+=".html"),a=l+e,(n=o.get(a))?t(n):f(e,!1).then(function(e){n=e,t(n)},function(){n=o.get(l+r),t(n)})})}if(!r.data)throw"No formula options provided!";r.schema=new i,r.data.model&&t.set(r.data.model),l.setTemplates(r.data.templates),r.template=r.data.template||"default",r.language={uri:r.data.language||null,code:null};var p=[h(r.data.template),r.schema.deref(r.data.schema)];r.data.form&&p.push(e(r.data.form));var m=u.all(p).then(function(e){return r.form=r.data.formula=new a(e[1],e[2]),r.form.onsave=r.data.onsave,r.form.translate(r.language.code),s(angular.element(e[0]))(r,function(e,t){c.prepend(e)}),!0});r.$watch("data.language",function(e,t){if(e&&e!==t){var i=n.code(e);m.then(function(){i?(r.language.code=i,r.form.translate(i)):n.add(e).then(function(e){r.language.code=e,r.form.translate(e)})})}}),r.$watch("data.model",function(e,i){e&&e!==i&&m.then(function(){t.set(e)&&r.form.updateValues()})},!0),this.data=r.data}]}}])}(),angular.module("formula").factory("formulaField",["$filter","formulaLog","formulaFormat","formulaAutoCompleteService","formulaCustomTemplateService",function(e,t,i,a,n){function l(e,i,a,n){if("object"==typeof e){this.parents=a||[],this.id=i,this.path=null,this.schema=e,this.fieldDefinition=n||{},f(this,e),f(this,n),this.required=this.schema.required&&-1!==this.schema.required.indexOf(this.id);var l=[".","/","#"];angular.forEach(l,function(e){this.id&&this.id.indexOf(e)>=0&&t.warning(t.codes.FIELD_INVALID_ID,{character:e,field:this.path})},this),this.uidGen(),this.pathGen(),this.attrsSet()}return console.log("new Field()",this),this}var r=function(i){if("string"==typeof i["default"]){var a,n=i["default"].match(/^%(.*)%$/);if(n){switch(n[1]){case"date":a=e("date")(new Date,"yyyy-MM-dd","UTC");break;case"datetime":a=e("date")(new Date,"yyyy-MM-ddThh:mm:ss","UTC")+"Z";break;case"time":a=e("date")(new Date,"hh:mm:ss","UTC");break;case"year":a=e("date")(new Date,"yyyy","UTC");break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TOKEN,{token:n[1],field:i.path})}a&&(i["default"]=a)}}},s=function(e){e.type instanceof Array&&(e.nullable=e.type.some(function(e){return"null"===e}),1===e.type.length?e.type=e.type[0]:2===e.type.length?"null"===e.type[0]?e.type=e.type[1]:"null"===e.type[1]&&(e.type=e.type[0]):(e.types=e.type,e.type="any"))},o=function(e){if(s(e),e.autocomplete)e.type="input:autocomplete";else if("select"===e.type||e["enum"])e.type="input:select";else if(e.format){var a=e.format.replace("-","");if(i[a]){switch(a){case"date":case"datetime":case"time":e.type="input:"+a;break;default:e.type="input:text"}tv4.addFormat(e.format,i[a])}else t.warning(t.codes.FIELD_UNSUPPORTED_FORMAT,{format:e.format,field:e.path}),e.type="input:text"}else switch(e.type){case"any":e.type="input:any";break;case"array":if(e.values=[],e.schema.items){var n=e.schema.items;e.fieldDefinition.fields&&f(n,e.fieldDefinition.fields[0]),"object"===n.type?e.type="array:object":"array"===n.type?e.type="array:array":n["enum"]?(e["enum"]=n["enum"],e.multiple=!0,e.type="input:select"):n.allOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"allOf",field:e.path}):n.anyOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"anyOf",field:e.path}):n.oneOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"oneOf",field:e.path}):e.type="array:field",e.schema.minItems>=1&&(e.required=!0)}else t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"items",field:e.path}),e.type=null;break;case"boolean":case"checkbox":e.type="input:checkbox",e.value=!!e.value;break;case"integer":case"number":e.type="input:number";break;case"range":e.type="input:range";break;case"object":e.schema.properties||(t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"properties",field:e.path}),e.type=null);break;case"textarea":e.type="input:textarea";break;case"string":case"text":e.type="input:text";break;case void 0:e.type="input:text";break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TYPE,{type:e.type,field:e.path}),e.type=null}},f=function(e,t){if("object"==typeof e||"object"==typeof t){var i="autocomplete,condition,default,description,disabled,enum,format,hidden,maximum,maxLength,minimum,minLength,multiple,nullable,pattern,readonly,required,step,title,type,values".split(",");angular.forEach(t,function(t,a){-1!==i.indexOf(a)&&(e[a]=t)})}},u=function(e){return"string"==typeof e&&"!"===e.charAt(0)};return l.uids=[],l.prototype={attrsSet:function(){return r(this),o(this),(this.typeOf("array")||this.typeOf("object"))&&this.fieldAdd(),n.initField(this),this.pattern&&!this.schema.pattern&&(this.schema.pattern=this.pattern),this.typeOf("array")&&this.schema.minItems&&this.itemAdd(),this.id&&"_"===this.id[0]&&this.hidden!==!1&&(t.debug(t.codes.FIELD_HIDDEN_DEFAULT,{field:this.path}),this.hidden=!0),this.visible=this.hidden?!1:!0,void 0===this.value&&void 0===(this.value=this["default"])&&(this.value=null),this["default"]&&this.typeOf("array")&&(this["default"]instanceof Array||(this["default"]=[this["default"]])),this.typeOf("select")&&!this.multiple&&null===this.value&&(this.value=this["enum"][0]),this.typeOf("autocomplete")&&a.initField(this),this},fieldAdd:function(){var e,t=this.parents.slice();if(t.push({id:this.id,index:this.index}),this.fields||(this.fields=[]),this.typeOf("array")){var i=this.schema.items.id||(this.id||/\/(.*?)$/.exec(this.path)[1])+"_"+(this.schema.items.type||"any"),a=this.fieldDefinition.fields?this.fieldDefinition.fields[0]:null,n=this.schema.items;n.required=this.schema.required,e=new l(n,i,t,a),e.index=this.fields.length,this.fields.push(e)}else this.typeOf("object")&&Object.keys(this.schema.properties).forEach(function(e){var i,a=this.schema.properties[e];if(this.fieldDefinition.fields&&this.fieldDefinition.fields.forEach(function(t){(e===t.id||e===t)&&(i=t)}),!u(i)){a.required=this.schema.required;var n=new l(a,e,t,i);n.index=this.fields.length,this.fields.push(n)}},this)},fieldFromID:function(e){var t=null;return angular.forEach(this.fields,function(i){t||i.id!==e||(t=i)}),t},itemAdd:function(){if(this.typeOf("array")&&this.fields){var e,t=[];this.parents.forEach(function(e){t.push(e)}),t.push({id:this.id,index:this.index}),e=this.values.push(angular.copy(this.fields[0]))-1;var i=this.values[e];return i.index=e,i.parents=t,i.uidGen(),i.pathGen(),this.dirty=!0,this.validate(!1),i}return null},itemIndex:function(e){for(var t in this.fields)if(this.fields[t].id===e)return t;return-1},itemRemove:function(e){this.typeOf("array")&&(this.values.length>e&&this.values.splice(e,1),this.values.forEach(function(e,t){e.index=t,e.pathGen()},this),this.dirty=!0,this.validate(!1))},itemToggle:function(e){this.typeOf("array")&&this.values.length>e&&(this.values[e].visible=!this.values[e].visible)},pathGen:function(){this.path="#/",angular.forEach(this.parents,function(e){null!=e.index&&(this.path+=e.index+"/"),this.path+=e.id+"/"},this),null!=this.index?(this.path+=this.index,this.id&&(this.path+="/"+this.id)):this.id&&(this.path+=this.id)},typeOf:function(e){if(this.type&&"string"==typeof e){var t=this.type.split(":"),i=!1;return angular.forEach(e.split(" "),function(e){(!i&&e===this.type||e===t[0]||e===t[1])&&(i=!0)},this),i}return!1},uidGen:function(e){for(var t="formula-",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a=0;(e?e:8)>a;++a)t+=i[Math.floor(Math.random()*i.length)];return-1!==l.uids.indexOf(t)?this.uidGen(e):(this.uid=t,t)},isEmpty:function(){return null==this.value||0===this.value.length},validate:function(e){if(this.schema){var t,i;switch(this.valid=!0,this.type){case"array:fieldset":case"array:field":this.value=[],angular.forEach(this.values,function(t){(t.dirty||e)&&t.validate(e),this.value.push(t.value)},this);break;case"input:any":if(this.value)if(isNaN(this.value))if(i=this.value.match(/^\[(.*)\]$/))t=[i[1]];else switch(this.value.toLowerCase()){case"true":t=!0;break;case"false":t=!1;break;case"null":t=null}else t=Number(this.value);break;case"input:checkbox":this.value=!!this.value;break;case"input:integer":case"input:number":case"input:range":t=null===this.value?NaN:Number(this.value);break;case"input:select":if(this.multiple&&!this.value)this.value=[];else switch(this.schema.type){case"integer":case"number":this.value=Number(this.value)}break;case"object":this.value=this.value||{},this.fields&&angular.forEach(this.fields,function(t,i){(t.dirty||e)&&t.validate(e),this.value[t.id]=t.value},this)}if(!this.dirty&&!e||!this.required&&this.isEmpty()||(this.valid=tv4.validate(void 0!==t?t:this.value,this.schema)),!this.valid&&this.nullable){switch(typeof this.value){case"string":this.value&&this.value.length||(this.value=null);break;case"number":isNaN(this.value)&&(this.value=null);break;case"object":Object.keys(this.value).length||(this.value=null)}this.isEmpty()&&(this.valid=!0)}return this.error=this.valid?null:tv4.error.message,this.dirty=!1,this.valid}return!1},valueFromModel:function(e){void 0!==e[this.id]&&("object"===this.type?this.fields.forEach(function(t,i){e[this.id][t.id]&&t.valueFromModel(e[this.id])},this):this.typeOf("array")?(this.values=[],e[this.id].forEach(function(e,t){if(this.itemAdd(),this.typeOf("fieldset")){var i={};i[this.values[t].id]=e,this.values[t].valueFromModel(i)}else this.typeOf("field")&&(this.values[t].value=e)},this)):(this.value=e[this.id],this.dirty=!0),n.initField(this),this.validate(!1))},nrArrayValues:function(){return this.values?this.values.reduce(function(e,t){return e+(t.hidden?0:1)},0):void 0}},l}]),angular.module("formula").factory("formulaForm",["formulaJsonLoader","formulaModel","formulaField","formulaI18n",function(e,t,i,a){function n(e){if(e&&"object"===e.type){var a=[{fields:[]}];return Object.keys(e.properties).forEach(function(n){var l=e.properties[n],r=new i(l,n);r.valueFromModel(t.data),a[0].fields.push(r)}),a}return null}function l(e,t){this.errors=null,this.i18n=a(null),this.schema=e,this.title=null,this.valid=!1,t?(this.title=t.title,this.fieldsets=r(e,t)):this.fieldsets=n(e),this.onsave=function(e){window.open("data:application/json,"+JSON.stringify(e))}}var r=function(e,a){if(e&&"object"===e.type&&a.fieldsets){var n=[];return a.fieldsets.forEach(function(a,l){var r={title:a.title,active:l?!1:!0,fields:[]};a.fields.forEach(function(n,l){var s;s="string"==typeof n?n:n.id;var o=[{id:a.title}],f=new i(e.properties[s],s,o,n);f.valueFromModel(t.data),r.fields.push(f)}),n.push(r)}),n}return null};return l.prototype={updateValues:function(){this.fieldsets.forEach(function(e){e.fields.forEach(function(e){e.valueFromModel(t.data)})})},activate:function(e){this.fieldsets.forEach(function(t,i){("object"==typeof e||"number"==typeof e)&&(("object"==typeof e?t===e:i===e)?t.active=!0:t.active=!1)})},toggleArrays:function(){this.fieldsets.forEach(function(e){e.fields.forEach(function(e){e.values.forEach(function(t,i){e.itemToggle(i)})})})},save:function(e,i){if(i!==!1&&!this.validate(!0))throw console.warn("Document not vaild",this.errors),this.errors;"function"==typeof this.onsave&&this.onsave(t.data)},translate:function(e){function t(e,i){var a=i&&i.fields?i.fields[e.id]||null:null;("array:fieldset"===e.type||"object"===e.type)&&(angular.forEach(e.fields,function(e){t(e,a)}),angular.forEach(e.values,function(e){angular.forEach(e.fields,function(e){t(e,a)})})),a?(e.title=a.title||e.title,void 0===e.title&&(e.title=e.id),e.description=a.description||e.description,e.typeOf("select")&&(e.values=[],angular.forEach(e["enum"],function(t,i){e.values.push({id:t,label:a.values?a.values[i]||t:t})}))):(e.title=e.title,void 0===e.title&&(e.title=e.id),e.typeOf("select")&&(e.values=[],angular.forEach(e["enum"],function(t){e.values.push({id:t,label:t})})))}this.i18n=a(e),angular.forEach(this.fieldsets,function(e,i){this.i18n.fieldsets&&(e.title=this.i18n.fieldsets[i]||e.title),angular.forEach(e.fields,function(e){t(e,this.i18n)},this)},this)},validate:function(e){var i=[],a=function(n){n.typeOf("array")?n.values.forEach(function(e){a(e)}):n.typeOf("object")?n.fields.forEach(function(e){a(e)}):(n.dirty||e)&&(n.validate(e)?t.data[n.id]=n.value:(i.push(n.path+" ("+n.error+")"),delete t.data[n.id]))};return this.fieldsets.forEach(function(e){e.fields.forEach(function(e){a(e)})}),this.errors=i,(this.valid=!this.errors.length)&&(this.errors=null),this.valid}},l}]),angular.module("formula").factory("formulaFormat",function(){return{color:function(e,t){var i="aqua,black,blue,fuchsia,gray,green,lime,maroon,navy,olive,orange,purple,red,silver,teal,white,yellow";return"string"!=typeof e||-1===i.split(",").indexOf(e.toLowerCase())&&!/^(#([a-f0-9]{3}|[a-f0-9]{6})|rgb\(\s?\d{1,3}%?,\s?\d{1,3}%?,\s?\d{1,3}%?\s?\))$/i.test(e)?"CSS 2.1 color":null},date:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}$/.test(e)?null:"ISO 8601 date, e.g. 2015-11-30 (year-month-day)"},datetime:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}T\d{2}(:\d{2}){2}(.\d+)?(([+-](\d{2}|\d{4}|\d{2}:\d{2}))|Z)$/.test(e)?null:"ISO 8601 datetime, e.g. 2015-11-30T23:45:30Z"},datefullyear:function(e,t){return"string"==typeof e&&/^\d{4}$/.test(e)?null:"RFC 3339 fullyear, e.g. 2015"},email:function(e,t){var i=/^[-+a-z0-9!#$%&'*=?^_`{|}~\/]([-+a-z0-9!#$%&'*=?^_`{|}~\/]|\.(?!\.)){0,62}[-+a-z0-9!#$%&'*=?^_`{|}~\/]$/i,a=/^[-a-z0-9]([-a-z0-9]|\.(?!\.)){0,253}[-a-z0-9]$/i,n=/\(.*\)/g,l="string"==typeof e?e.split("@"):[];return 2===l.length&&e.length<=254&&i.test(l[0].replace(n,""))&&a.test(l[1].replace(n,""))?null:"RCF 3696 e-mail address"},time:function(e,t){return"string"==typeof e&&/^\d{2}(:\d{2}){2}$/.test(e)?null:"ISO 8601 time, e.g. 23:45:30"},uri:function(e,t){return"string"==typeof e&&/^([a-z][a-z0-9+.-]*):(?:\/\/((?:(?=((?:[a-z0-9-._~!$&'()*+,;=:]|%[0-9A-F]{2})*))(\3)@)?(?=(\[[0-9A-F:.]{2,}\]|(?:[a-z0-9-._~!$&'()*+,;=]|%[0-9A-F]{2})*))\5(?::(?=(\d*))\6)?)(\/(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\8)?|(\/?(?!\/)(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\10)?)(?:\?(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\11)?(?:#(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\12)?$/i.test(e)?null:"RFC 3986 URI"}}}),angular.module("formula").factory("formulaI18n",["formulaJsonLoader","formulaLog","$q",function(e,t,i){function a(e){return e&&a.cache[e]?a.cache[e]:{add:["Add","Click to add a new item"],invalid:"{count} invalid fields",maximize:["Maximize","Click to maximize item"],minimize:["Minimize","Click to minimize item"],remove:["Remove","Click to remove item"],required:"Required field",save:["Save","Click to save document"],validate:["Validate","Click to validate form"],code:null,fields:{},fieldsets:[],uri:null}}return a.cache={},a.add=function(n){var l=i.defer();return n?e(n).then(function(e){var i=e["iso639-3"];i?(a.cache[i]={code:i,fields:e.fields,fieldsets:e.fieldsets,uri:n},angular.forEach(e.labels,function(e,t){a.cache[i][t]=e}),l.resolve(i)):t.warning(t.codes.I18N_MISSING_CODE,{uri:n})}):l.reject("not a valid translation JSON URI: "+n),l.promise},a.code=function(e){var t=null;return angular.forEach(a.cache,function(i,a){t||i.uri!==e||(t=a)}),t},a}]),angular.module("formula").factory("formulaJsonLoader",["$http","$q","formulaLog",function(e,t,i){var a;return a=function(n,l,r){var s=t.defer();return(l?e.jsonp(n+"?callback=JSON_CALLBACK"):e.get(n)).success(function(e,t,i,a){s.resolve(e)}).error(function(e,t,r,o){return l?(i.error(i.codes.JSON_LOAD_ERROR,{uri:n}),void s.reject(n)):a(n,!0)}),s.promise}}]),angular.module("formula").factory("formulaLog",[function(){function e(e,t){var i=e,a=i.match(/\{[^\}]*\}/g);return angular.forEach(a,function(e,a){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}var t={FIELD_INVALID_ID:"field ID contains an illegal character: {character} ({field})",FIELD_MISSING_PROPERTY:"missing required field property: {property} ({field})",FIELD_UNSUPPORTED_FORMAT:"unsupported string format: {format} ({field})",FIELD_UNSUPPORTED_PROPERTY:"unsupported field property: {property} ({field})",FIELD_UNSUPPORTED_TOKEN:"unsupported default token: {token} ({field})",FIELD_UNSUPPORTED_TYPE:"unsupported field type: {type} ({field})",FIELD_HIDDEN_DEFAULT:"field hidden by default: {field}",I18N_MISSING_CODE:"missing ISO 639-3 language code: {uri}",JSON_LOAD_ERROR:"could not load JSON document: {uri}",SCHEMA_INVALID_URI:"invalid URI for schema deref: {uri}",SCHEMA_MISSING_PROPERTY:"missing required schema property: {property} ({schema})",SCHEMA_MISSING_REFERENCE:"missing schema reference: {schema}"};return{codes:t,debug:function(t,i){i?console.debug(e(t,i)):console.debug(t)},error:function(t,i){console.error(e(t,i))},warning:function(t,i){console.warn(e(t,i))}}}]),angular.module("formula").service("formulaModel",function(){var e={data:{},set:function(e){return e?(this.data=e,!0):!1}};return e}),angular.module("formula").factory("formulaSchema",["$q","formulaJsonLoader","formulaLog",function(e,t,i){function a(e){this.deferred=null,this.json=null,this.uri=e||null}return a.cache={},a.prototype={compile:function(){function e(e){if("#"===e[0]){e=e.substr("/"===e[1]?2:1).split("/");var t=n.json;return angular.forEach(e,function(e){t&&(t=t[e])}),t}return null}function t(i,n,l){var r,s=[];return angular.forEach(i,function(o,f){"object"==typeof o?s=s.concat(t(o,i,f)):"$ref"===f&&n&&("#"===o[0]?(r=e(o))?n[l]=r:(s.push(o),delete n[l]):a.cache[o]&&a.cache[o].json?n[l]=a.cache[o].json:(s.push(o),delete n[l]))}),s}var n=this,l=this.json?t(this.json):[this.uri];return l.length?(angular.forEach(l,function(e){i.warning(i.codes.SCHEMA_MISSING_REFERENCE,{schema:e})}),!1):!0},deref:function(n){var l=this;if(this.deferred=e.defer(),n&&"string"==typeof n)if(a.cache[n])a.cache[n].then(function(e){l.json=e,l.deferred.resolve(e)});else{var r={schema:a.cache[n]=new a(n),missing:null,resolve:function(e){if(e&&this.missing instanceof Array){var t=this.missing.indexOf(e);-1!==t&&this.missing.splice(t,1)}this.missing&&this.missing.length||(this.schema.compile(),l.json=this.schema.json,l.deferred.resolve(l.json))}};t(n).then(function(e){r.schema.json=e;var t=r.schema.missing(!1);t?(r.missing=angular.copy(t),angular.forEach(t,function(e){if(a.cache[e])a.cache[e].then(function(){r.resolve(e)});else{var t=new a;t.deref(e).then(function(){r.resolve(e)})}})):r.resolve()},function(e){l.deferred.reject(e)})}else i.warning(i.codes.SCHEMA_INVALID_URI,{uri:n}),this.deferred.reject("Invalid schema URI: "+n);return this},missing:function(e){function t(i){var n=[];return angular.forEach(i,function(i,l){if("object"==typeof i){var r=t(i);angular.forEach(r,function(e){n.push(e)})}else"$ref"===l&&"#"!==i[0]&&(e&&a.cache[i]||n.push(i))}),n}var i=t(this.json);return i.length?i:null},then:function(e){this.deferred?this.deferred.promise.then(function(t){e(t)},function(e){}):e(this.json)}},a}]),angular.module("formula").filter("formulaInlineValues",function(){return function(e,t){var i=[];return angular.forEach(e,function(e){if(e.value instanceof Array)i.push("Array["+e.value.length+"]");else switch(typeof e.value){case"string":case"number":case"boolean":i.push(e.value)}}),i.join(", ")}}),angular.module("formula").filter("formulaReplace",function(){return function(e,t){var i=e,a=e.match(/\{[^\}]*\}/g);return angular.forEach(a,function(e,a){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}}),angular.module("formula").run(["$templateCache",function(e){e.put("formula/bootstrap3.html",'<form class="form-horizontal" ng-if="form.fieldsets"><header ng-if="form.title" class="page-header" style="margin-top: -10px"><h2>{{ form.title }}</h2></header><ul class="nav nav-tabs"><li ng-repeat="fieldset in form.fieldsets" ng-if="form.fieldsets.length > 1" ng-class="{ active: fieldset.active }"><a href="" ng-click="form.activate(fieldset)">{{ fieldset.title }}</a></li></ul><fieldset ng-repeat="fieldset in form.fieldsets" ng-if="fieldset.active" style="border: 1px solid #ddd; border-radius: 0 0 5px 5px; border-top: 0; padding: 15px; padding-bottom: 0;"><div ng-repeat="field in fieldset.fields" ng-show="field.visible" formula:field-definition=""><div ng-if="field.typeOf(\'input\')" title="{{ field.description }}" class="form-group has-feedback"><label for="{{ field.uid }}" class="col-sm-3 control-label">{{ field.title }}</label><div class="col-sm-9" ng-class="{ \'has-error\': field.error, \'has-success\': field.valid, \'has-warning\': (field.required && field.value === null) }"><div ng-if="!field.typeOf(\'select\')"><input class="form-control input-md" formula:field="field"><div ng-if="!field.typeOf(\'checkbox\') && (field.error || field.valid)"><span ng-if="field.valid" class="glyphicon glyphicon-ok form-control-feedback"></span> <span ng-if="field.error" class="glyphicon glyphicon-remove form-control-feedback"></span></div></div><select ng-if="field.typeOf(\'select\')" class="form-control input-md" formula:field="field"><option ng-repeat="value in field.values" value="{{ value.id }}">{{ value.label }}</option></select><span class="help-block">{{ field.error || field.description }}</span></div></div><div ng-if="field.typeOf(\'object\')"><div class="panel" ng-class="{ \'panel-danger\': field.error, \'panel-success\': field.valid }" formula:field="field"><div class="panel-heading">{{ field.title }}</div><div class="panel-body"><div ng-repeat="field in field.fields" ng-show="field.visible"><formula:field-instance field="field"></formula:field-instance></div></div></div></div><div ng-if="field.typeOf(\'array\')"><div formula:field="field"><div ng-if="field.typeOf(\'fieldset\')" class="panel" ng-class="{ \'panel-danger\': field.error, \'panel-success\': field.valid }"><div class="panel-heading">{{ field.title }} ({{ field.nrArrayValues() || 0 }})</div><ul class="list-group"><li class="list-group-item" ng-repeat="value in field.values" ng-if="!value.hidden"><fieldset><legend style="border: none; margin-bottom: 10px; text-align: right;"><span ng-class="{ \'text-danger\': !value.valid, \'text-success\': value.valid }" class="pull-left" ng-if="!value.visible" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 80%; text-align: left;">{{ value.fields | formulaInlineValues }}</span> <button style="font-family: monospace;" class="btn btn-sm btn-info" ng-click="field.itemToggle($index)" type="button" title="{{ value.visible ? form.i18n.minimize[1] : form.i18n.maximize[1] }}">{{ value.visible ? \'_\' : \'‾\' }}</button> <button class="btn btn-sm btn-danger" ng-click="field.itemRemove($index)" type="button" title="{{ form.i18n.remove[1] }}">X</button></legend><formula:field-instance field="value" ng-show="value.visible"></formula:field-instance></fieldset></li></ul><div class="panel-footer clearfix has-feedback" ng-class="{ \'has-error\': field.error, \'has-success\': field.valid }"><span class="help-block"><span>{{ field.error || field.description }}</span> <button class="btn btn-sm btn-primary pull-right" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}">{{ form.i18n.add[0] }}</button></span></div></div><div ng-if="field.typeOf(\'field\')" class="panel" ng-class="{ \'panel-danger\': field.error, \'panel-success\': field.valid }"><div class="panel-heading">{{ field.title }}</div><ul class="list-group"><li class="list-group-item" ng-repeat="value in field.values"><div class="input-group"><input formula:field="value" class="form-control input-md"> <span class="input-group-btn"><button class="btn btn-danger" ng-click="field.itemRemove($index)" type="button" title="{{ form.i18n.remove[1] }}">X</button></span></div></li></ul><div class="panel-footer clearfix has-feedback" ng-class="{ \'has-error\': field.error, \'has-success\': field.valid }"><span class="help-block"><span>{{ field.error || field.description }}</span> <button class="btn btn-sm btn-primary pull-right" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}">{{ form.i18n.add[0] }}</button></span></div></div></div></div></div></fieldset><div class="has-feedback" ng-class="{ \'has-error\': !form.valid, \'has-success\': form.valid }" style="margin-top: 10px;"><span class="help-block"><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: form.errors.length } }}</span><div ng-if="!data.hideButtons" class="btn-group pull-right"><button type="button" class="btn btn-info" ng-click="form.validate(true)" title="{{ form.i18n.validate[1] }}">{{ form.i18n.validate[0] }}</button> <button type="button" class="btn btn-success" ng-class="{ disabled: !form.valid }" ng-click="form.save()" title="{{ form.i18n.save[1] }}">{{ form.i18n.save[0] }}</button></div></span></div></form><div ng-if="!form.fieldsets" class="alert alert-info" style="text-align: center; overflow: hidden;"><span>Loading schema...</span></div>'),e.put("formula/default.html",'<form class="formula" ng-if="form.fieldsets"><header ng-if="form.title">{{ form.title }}</header><nav ng-if="form.fieldsets.length > 1"><a ng-repeat="fieldset in form.fieldsets" ng-class="{ active: fieldset.active }" href="" ng-click="form.activate(fieldset)">{{ fieldset.title }}</a></nav><fieldset ng-repeat="fieldset in form.fieldsets" ng-if="fieldset.active"><legend ng-if="fieldset.title">{{ fieldset.title }}</legend><div ng-repeat="field in fieldset.fields" ng-show="field.visible" formula:field-definition=""><div ng-if="field.typeOf(\'input\')" title="{{ field.description }}" ng-class="{ valid: field.valid, error: field.error, required: (field.required && field.value == null) }"><label for="{{ field.uid }}">{{ field.title }}</label> <input formula:field="field"> <span>{{ field.error || field.description }}</span></div><div ng-if="field.typeOf(\'object\')"><fieldset><legend ng-if="field.title">{{ field.title }}</legend><div ng-repeat="field in field.fields" ng-show="field.visible"><formula:field-instance field="field"></formula:field-instance></div></fieldset></div><div ng-if="field.typeOf(\'array\')"><div><fieldset ng-class="{ valid: field.valid, error: field.error }"><legend>{{ field.title }} ({{ field.nrArrayValues() || 0 }})</legend><ul ng-if="field.typeOf(\'fieldset\')"><li ng-repeat="value in field.values" ng-if="!value.hidden"><fieldset ng-class="{ valid: value.valid }"><legend><span ng-if="!value.visible">{{ value.fields | formulaInlineValues }}</span> <a href="" class="toggle" ng-click="field.itemToggle($index)" title="{{ value.visible ? form.i18n.minimize[1] : form.i18n.maximize[1] }}">{{ value.visible ? \'_\' : \'‾\' }}</a> <a href="" class="remove" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">X</a></legend><formula:field-instance field="value" ng-show="value.visible"></formula:field-instance></fieldset></li><li><span>{{ field.error || field.description }}</span> <button class="add" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}"><strong>+</strong> {{ form.i18n.add[0] }}</button></li></ul><ul ng-if="field.typeOf(\'field\')"><li ng-repeat="value in field.values" ng-class="{ valid: value.valid, error: value.error }"><formula:field-instance field="value" ng-show="value.visible"><a href="" class="remove" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">X</a> <span ng-if="value.error">{{ value.error }}</span></formula:field-instance></li><li><span>{{ field.error || field.description }}</span> <button class="add" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}"><strong>+</strong> {{ form.i18n.add[0] }}</button></li></ul></fieldset></div></div></div></fieldset><footer><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: form.errors.length } }}</span> <button ng-if="!data.hideButtons" ng-click="form.validate(true)" title="{{ form.i18n.validate[1] }}"><strong>&#10003;</strong> {{ form.i18n.validate[0] }}</button> <button ng-if="!data.hideButtons" ng-disabled="!form.valid" ng-click="form.save()" title="{{ form.i18n.save[1] }}"><strong>&#9921;</strong> {{ form.i18n.save[0] }}</button></footer></form><div class="formula" ng-if="!form.fieldsets"><div class="loading"><div class="spinner"></div><span>Loading...</span></div></div>')}]),angular.module("formula").service("formulaAutoCompleteService",["$http","$q",function(e,t){const i=/^(https?|\/\/)/,a="Invalid autocomplete source ";var n={},l=function(e){return n[e]&&n[e].constructor===Function},r=function(e){return e.constructor===Object&&e.hasOwnProperty("source")&&e.hasOwnProperty("callback")},s=function(e){return e&&(i.test(e)||r(e)&&s(e.source))},o=function(e,t){n[e]=t},f=function(s,o){var u=t.defer();if(l(s))u.resolve(n[s].call({}));else if(i.test(s)){var d=o?{params:{q:o}}:{};e.get(s,d).then(function(e){u.resolve(e.data)},function(e){
u.reject(new Error(a+s))})}else s.constructor===Array?u.resolve(s):r(s)?f(s.source,o).then(function(e){u.resolve(n[s.callback].call({},e))},function(e){u.reject(new Error(a+s))}):u.resolve(s.filter(function(e){return-1!==e.indexOf(o)}));return u.promise},u=function(e){e.source=[],f(e.autocomplete).then(function(t){e.source=t},function(t){console.warn(t),e.source=[]}),e.querySearch=function(t){return f(e.autocomplete,t)}};return{defineSourceFunction:o,getSource:f,isURI:s,initField:u}}]),angular.module("formula").service("formulaCustomTemplateService",["$templateCache","$templateRequest","$q",function(e,t,i){var a,n=function(e,t){if(e)for(var i in e)if(e[i].match&&e[i].match.call({},angular.copy(t)))return e[i];return null},l=function(a){var n=e.get(a);if(!n)return t(a,!1);var l=i.defer();return l.resolve(n),l.promise},r=function(e,t){var a=i.defer(),r=n(e,t);return r?r.hidden?a.resolve(!1):null!=r.template?""===r.template?a.resolve(!1):a.resolve(r.template):r.templateUrl?l(r.templateUrl).then(function(e){a.resolve(e)},function(){a.reject()}):a.reject():a.reject(),a.promise},s=function(e){a&&r(a,e).then(function(t){t?e.customTemplate=t:e.hidden=!0})},o=function(e){a=e};return{setTemplates:o,initField:s}}]),angular.module("formula").service("formulaEvaluateConditionsService",["formulaModel",function(e){var t=function(t,i){i.condition&&(t.model=e.data,t.$watchCollection("model",function(e){var a=!0,n=i.condition instanceof Array?i.condition:[i.condition];if(angular.forEach(n,function(n){var l,r=e,s=i.parents;if(a){"#"===n[0]&&(s=[],"/"===n[1]?l=n.substr(1).split("/"):(l=n.substr(1).split("."),l[0].length||s.splice(0,1)),angular.forEach(l,function(e,t){isNaN(e)?s.push({id:e,index:null}):t>0&&(s[t-1].index=Number(e))}),n=s[s.length-1].id,s.splice(s.length-1,1)),angular.forEach(s,function(e){r&&(r=null!==e.index?r[e.index][e.id]:r[e.id])}),r&&null!==i.index&&(r=r[i.index]);var o=t.$eval(n,r);r&&void 0!==o&&o!==!1||(a=!1)}}),i.visible!==(i.visible=i.hidden?!1:a)){var l=i.value;i.value=t.backupValue,t.backupValue=l}}))};return{evaluateConditions:t}}]);