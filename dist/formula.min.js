"use strict";angular.module("formula",[]),function(){angular.module("formula").directive("formulaFieldDefinition",[function(){return{restrict:"A",require:"^formula",scope:!1,compile:function(e,t){t.$set("formulaFieldDefinition");var i=e.html();return function(e,t,a,r){r.fieldDefinition=i}}}}])}(),function(){angular.module("formula").directive("formulaFieldInstance",["$compile",function(e){return{restrict:"AE",require:"^formula",scope:{field:"="},compile:function(){return function(t,i,a,r){var n=angular.element(r.fieldDefinition);e(n)(t,function(e,t){i.prepend(e)})}}}}])}(),function(){angular.module("formula").directive("formulaField",["$compile","$q",function(e,t){var i=function(e,i,r){var n,l=e.field,o=a(l),u=t.defer();switch(o.sub){case"textarea":n=angular.element("<textarea>");break;case"select":n=angular.element("<select>"),i.children().length?angular.forEach(i.children(),function(e){n.append(e)}):n.attr("ng-options","value.id as value.label for value in field.values"),l.multiple&&n.attr("multiple","multiple");break;default:switch(n=angular.element("<input>"),n.attr("type",o.sub),o.sub){case"number":case"range":null!==l.step&&n.attr("step",l.step);break;case"any":case"date":case"datetime":case"time":n.attr("type","text")}}if(angular.forEach(r,function(e,t){r.$attr[t]&&n.attr(r.$attr[t],e)}),"autocomplete"===o.sub){var s=angular.element("<datalist>"),f=l.id+"_list";n=angular.element("<input>"),n.attr("list",f),s.attr("id",f),l.querySearch("").then(function(e){e.forEach(function(e){var t=angular.element("<option>");t.attr("value",e),s.append(t)}),u.resolve(n)}),s.on("change",l.onSelect),n.append(s)}else u.resolve(n);return u.promise},a=function(e){var t=e.type?e.type.split(":"):null;return t=t?{main:t[0],sub:t[1]}:null},r=function(e,t){t.$set("id",e.uid),t.$set("ngModel","field.value"),t.$set("formulaField"),e.disabled&&t.$set("disabled","disabled"),e.readonly&&t.$set("readonly","readonly")},n=function(e,t){e.form=t[0].data.formula,t[1]&&(e.field=t[1].field)},l=function(e,t){var i="formula-";angular.forEach(e.parents,function(e){i+=e.id+"/"}),e.id?i+=e.id:e.parents&&(i=i.substr(0,i.length-1)),t.addClass(i)},o=function(e,t){var i=e.mainType;i&&t.addClass("formula"+i.charAt(0).toUpperCase()+i.slice(1))},u=function(e,r,n,l){var o=t.defer(),u=e.field,s=a(u);if(u.customTemplate){var f=angular.element(u.customTemplate);f.addClass("formulaCustomObject"),o.resolve(f)}else"input"===s.main?i(e,r,n,s).then(function(e){o.resolve(e)}):o.resolve(angular.element(r));return o.promise};return{restrict:"A",require:["^formula","?^formulaFieldInstance"],scope:{field:"=formulaField"},link:function(t,i,a,s){var f=t.field;n(t,s),r(f,a),u(t,i,a,s).then(function(a){l(f,a),o(f,a),e(a)(t,function(e,t){i.replaceWith(e)})})},terminal:!0}}])}(),function(){angular.module("formula").directive("formula",["formulaJsonLoader","formulaModel","formulaSchema","formulaForm","formulaI18n","formulaCustomTemplateService","$http","$compile","$templateCache","$templateRequest","$q","$rootScope",function(e,t,i,a,r,n,l,o,u,s,f,d){return{restrict:"A",scope:{data:"=formula"},controller:["$scope","$attrs","$element",function(l,c,m){if(!l.data)throw"No formula options provided!";var p=function(e){var t=r.code(e);l.language={uri:e,code:t},t||r.add(e).then(function(e){l.language.code=e,l.form&&l.form.translate(e)})},h=function(e){return f(function(t,i){var a,r,n="formula/",l="default.html";e=e||l,".html"!==e.substr(-5)&&(e+=".html"),a=n+e,(r=u.get(a))?t(r):s(e,!1).then(function(e){r=e,t(r)},function(){r=u.get(n+l),t(r)})})},v=function(e){e&&y.then(function(){l.form.updateValues(e),l.data.ready=!0})};l.schema=new i,n.setTemplates(l.data.templates),l.template=l.data.template||"default",p(l.data.language);var g=[h(l.data.template),l.schema.deref(l.data.schema),Promise.resolve(l.data.model)];l.data.form&&g.push(e(l.data.form));var y=f.all(g).then(function(e){return v(e[2]),l.form=l.data.formula=new a(e[1],e[3]),l.form.onsave=l.data.onsave||l.form.onsave,l.form.translate(l.language.code),o(angular.element(e[0]))(l,function(e,t){m.prepend(e)}),!0});l.$watch("data.language",function(e,t){e&&e!==t&&p(e)}),l.$watchCollection("data.model",function(e,t){e&&e!==t&&v(e)}),l.$watchCollection("data.templates",function(e,t){e&&e!==t&&(n.setTemplates(e),l.form&&l.form.updateCustomTemplates())}),l.$on("$destroy",function(){l.form.fields().forEach(function(e){"function"==typeof e.destroyWatcher&&e.destroyWatcher()}),l.data.formula=void 0,t.data={},d.$on("revalidate",function(){})}),this.data=l.data}]}}])}(),angular.module("formula").factory("formulaField",["$filter","$rootScope","formulaLog","formulaFormat","formulaFieldAttributesService","formulaFieldValidateService","formulaFieldValueFromModelService",function(e,t,i,a,r,n,l){function o(e,t,i,a){return"object"==typeof e&&r.attrsSet(this,{schema:e,id:t,parents:i,fieldDefinition:a}),this}var u=function(e){return"string"==typeof e&&"!"===e.charAt(0)},s=function(e,t){return e+(t.hidden?0:1)};return o.uids=[],o.prototype={dirtyParents:function(){for(var e=this.parents.length-1;e>=0;e--)this.parents[e].dirty=!0,this.parents[e].itemChange(this)},fieldAdd:function(){var e,t=this.parents.slice();if(t.push(this),this.fields||(this.fields=[]),this.typeOf("array")){var i=/\/([^\/]*?)$/.exec(this.path)[1]+"_"+(this.schema.items.type||"any"),a={id:i};a.fields=this.fieldDefinition.fields||null;var r=this.schema.items;e=new o(r,i,t,a),e.index=this.fields.length,e.type&&this.fields.push(e)}else this.typeOf("object")&&Object.keys(this.schema.properties).forEach(function(e){var i,a=this.schema.properties[e];if(this.fieldDefinition.fields&&this.fieldDefinition.fields.forEach(function(t){var a;a="string"==typeof t?t.replace("!",""):t.id,e===a&&(i=t)}),!u(i)){a.required=a.required||this.schema.required;var r=new o(a,e,t,i);r.type&&this.fields.push(r)}},this)},fieldFromID:function(e){var t=null;return angular.forEach(this.fields,function(i){t||i.id!==e||(t=i)}),t},itemAdd:function(){if(this.typeOf("array")&&this.fields){var e,i=this.parents.slice();i.push(this);var a=this.fields[0],r=new o(a.schema,a.id,i,a.fieldDefinition);return r.type?(e=this.values.push(r)-1,r.index=e,a.customTemplate&&!r.customTemplate&&(r.customTemplate=a.customTemplate),void 0!==r.value&&this.value.push(r.value),this.dirty=!0,this.dirtyParents(),t.$emit("revalidate"),r):null}return null},itemIndex:function(e){for(var t in this.fields)if(this.fields[t].id===e)return t;return-1},itemRemove:function(e){this.typeOf("array")&&(this.values.length>e&&(this.values.splice(e,1),this.value.splice(e,1)),this.values.forEach(function(e,t){e.index=t},this),this.dirty=!0,this.dirtyParents(),t.$emit("revalidate"))},itemChange:function(e){switch(this.type){case"array:fieldset":case"array:field":this.values&&(this.value=[],angular.forEach(this.values,function(e){void 0!==e.value&&this.value.push(e.value)},this));break;case"object":this.fields&&(this.value={},angular.forEach(this.fields,function(e,t){void 0!==e.value&&(this.value[e.id]=e.value)},this))}},itemToggle:function(e){this.typeOf("array")&&this.values.length>e&&(this.values[e].visible=!this.values[e].visible)},get path(){var e="#",t=function(e){var t="/";return t+=null!=e.index?e.index:e.id};return this.parents.forEach(function(i){e+=t(i)}),e+=t(this)},typeOf:function(e){if(!this.type||"string"!=typeof this.type)return!1;var t=this.type.split(":"),i=!1;return e.split(" ").forEach(function(e){(!i&&e===this.type||e===t[0]||e===t[1])&&(i=!0)},this),i},uidGen:function(e){for(var t="formula-",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a=0;(e?e:8)>a;++a)t+=i[Math.floor(Math.random()*i.length)];return-1!==o.uids.indexOf(t)?this.uidGen(e):(this.uid=t,t)},isEmpty:function(){return null==this.value||0===this.value.length},validate:function(e,t){return n.validate(this,{force:e,silent:t})},valueFromModel:function(e){l.valueFromModel(this,e)},nrArrayValues:function(){return this.values?this.values.reduce(s,0):0}},o}]),angular.module("formula").factory("formulaForm",["$rootScope","formulaJsonLoader","formulaModel","formulaField","formulaI18n","formulaEvaluateConditionsService","formulaCustomTemplateService",function(e,t,i,a,r,n,l){function o(e){if(e&&"object"===e.type){var t=[{fields:[],id:"the-fieldset"}];return Object.keys(e.properties).forEach(function(r){var n=e.properties[r];n.required=e.required;var l=new a(n,r);l.valueFromModel(i.data),l.type&&t[0].fields.push(l)}),t}return null}function u(t,i){this.errors=null,this.i18n=r(null),this.schema=t,this.title=null,this.valid=!1,i?(this.title=i.title,this.fieldsets=s(t,i)):this.fieldsets=o(t),this.onsave=function(e){window.open("data:application/json,"+JSON.stringify(e))};var a=this;e.$on("revalidate",function(){a.validate()}),this.validate(!0,!0)}var s=function(e,t){if(e&&"object"===e.type&&t.fieldsets){var r=[];return t.fieldsets.forEach(function(t,n){var l={title:t.title,active:n?!1:!0,fields:[],id:t.title+n};t.fields.forEach(function(t,r){var n;n="string"==typeof t?t:t.id;var o=e.properties[n]||{id:n};o.required=o.required||e.required;var u=new a(o,n,null,t);u.valueFromModel(i.data),u.type&&l.fields.push(u)}),r.push(l)}),r}return null};return u.prototype={fields:function(){var e=[],t=function(t){e.push(t)};return this.fieldsets.forEach(function(e){e.fields.forEach(function(e){e.typeOf("array")?e.values.forEach(t):e.typeOf("object")&&e.fields.forEach(t),t(e)})}),e},updateValues:function(e){this.fieldsets.forEach(function(t){t.fields.forEach(function(t){t.valueFromModel(e)})}),this.validate(!1,!0)},updateCustomTemplates:function(){this.fields.forEach(function(e){l.initField(e)})},activate:function(e){this.fieldsets.forEach(function(t,i){("object"==typeof e||"number"==typeof e)&&(("object"==typeof e?t===e:i===e)?t.active=!0:t.active=!1)})},toggleArrays:function(){this.fieldsets.forEach(function(e){e.fields.forEach(function(e){e.values.forEach(function(t,i){e.itemToggle(i)})})})},save:function(e,t){if(t!==!1&&!this.validate(!0))throw console.warn("Document not vaild",this.errors),this.errors;"function"==typeof this.onsave&&this.onsave(i.data)},translate:function(e){function t(e,i){var a=i&&i.fields?i.fields[e.id]||null:null;("array:fieldset"===e.type||"object"===e.type)&&(angular.forEach(e.fields,function(e){t(e,a)}),angular.forEach(e.values,function(e){angular.forEach(e.fields,function(e){t(e,a)})})),a?(e.title=a.title||e.title,void 0===e.title&&(e.title=e.id),e.description=a.description||e.description,e.typeOf("select")&&(e.values=[],angular.forEach(e["enum"],function(t,i){e.values.push({id:t,label:a.values?a.values[i]||t:t})}))):(e.title=e.title,void 0===e.title&&(e.title=e.id),e.typeOf("select")&&(e.values=[],angular.forEach(e["enum"],function(t){e.values.push({id:t,label:t})})))}this.i18n=r(e),angular.forEach(this.fieldsets,function(e,i){this.i18n.fieldsets&&(e.title=this.i18n.fieldsets[i]||e.title),angular.forEach(e.fields,function(e){t(e,this.i18n)},this)},this)},validate:function(e,t){var a=this.errors||[],r=function(i){if(i.typeOf("array")?i.values.forEach(function(e){r(e)}):i.typeOf("object")&&i.fields.forEach(function(e){r(e)}),i.dirty||e){var n;i.validate(e,t)?-1!==(n=a.indexOf(i.path))&&a.splice(n,1):i.typeOf("input")&&(a.push(i.path),a=a.filter(function(e,t,i){return i.indexOf(e)===t}))}};return this.fieldsets.forEach(function(e){e.fields.forEach(function(e){r(e),e.valid?i.data[e.id]=e.value:delete i.data[e.id]})}),n.evaluateConditions(this),this.errors=a,(this.valid=!this.errors.length)&&(this.errors=null),this.valid}},u}]),angular.module("formula").factory("formulaFormat",[function(){return{color:function(e,t){var i="aqua,black,blue,fuchsia,gray,green,lime,maroon,navy,olive,orange,purple,red,silver,teal,white,yellow";return"string"!=typeof e||-1===i.split(",").indexOf(e.toLowerCase())&&!/^(#([a-f0-9]{3}|[a-f0-9]{6})|rgb\(\s?\d{1,3}%?,\s?\d{1,3}%?,\s?\d{1,3}%?\s?\))$/i.test(e)?"CSS 2.1 color":null},date:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}$/.test(e)?null:"ISO 8601 date, e.g. 2015-11-30 (year-month-day)"},datetime:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}T\d{2}(:\d{2}){2}(.\d+)?(([+-](\d{2}|\d{4}|\d{2}:\d{2}))|Z)$/.test(e)?null:"ISO 8601 datetime, e.g. 2015-11-30T23:45:30Z"},datefullyear:function(e,t){return"string"==typeof e&&/^\d{4}$/.test(e)?null:"RFC 3339 fullyear, e.g. 2015"},email:function(e,t){var i=/^[-+a-z0-9!#$%&'*=?^_`{|}~\/]([-+a-z0-9!#$%&'*=?^_`{|}~\/]|\.(?!\.)){0,62}[-+a-z0-9!#$%&'*=?^_`{|}~\/]$/i,a=/^[-a-z0-9]([-a-z0-9]|\.(?!\.)){0,253}[-a-z0-9]$/i,r=/\(.*\)/g,n="string"==typeof e?e.split("@"):[];return 2===n.length&&e.length<=254&&i.test(n[0].replace(r,""))&&a.test(n[1].replace(r,""))?null:"RCF 3696 e-mail address"},time:function(e,t){return"string"==typeof e&&/^\d{2}(:\d{2}){2}$/.test(e)?null:"ISO 8601 time, e.g. 23:45:30"},uri:function(e,t){return"string"==typeof e&&/^([a-z][a-z0-9+.-]*):(?:\/\/((?:(?=((?:[a-z0-9-._~!$&'()*+,;=:]|%[0-9A-F]{2})*))(\3)@)?(?=(\[[0-9A-F:.]{2,}\]|(?:[a-z0-9-._~!$&'()*+,;=]|%[0-9A-F]{2})*))\5(?::(?=(\d*))\6)?)(\/(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\8)?|(\/?(?!\/)(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\10)?)(?:\?(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\11)?(?:#(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\12)?$/i.test(e)?null:"RFC 3986 URI"}}}]),angular.module("formula").factory("formulaI18n",["formulaJsonLoader","formulaLog","$q",function(e,t,i){function a(e){return e&&a.cache[e]?a.cache[e]:{add:["Add","Click to add a new item"],invalid:"{count} invalid fields",maximize:["Maximize","Click to maximize item"],minimize:["Minimize","Click to minimize item"],remove:["Remove","Click to remove item"],required:"Required field",save:["Save","Click to save document"],validate:["Validate","Click to validate form"],code:null,fields:{},fieldsets:[],uri:null}}return a.cache={},a.add=function(r){var n=i.defer();return r?e(r).then(function(e){var i=e["iso639-3"];i?(a.cache[i]={code:i,fields:e.fields,fieldsets:e.fieldsets,uri:r},angular.forEach(e.labels,function(e,t){a.cache[i][t]=e}),n.resolve(i)):t.warning(t.codes.I18N_MISSING_CODE,{uri:r})}):n.reject("not a valid translation JSON URI: "+r),n.promise},a.code=function(e){var t=null;return angular.forEach(a.cache,function(i,a){t||i.uri!==e||(t=a)}),t},a}]),angular.module("formula").factory("formulaJsonLoader",["$http","$q","formulaLog",function(e,t,i){var a;return a=function(r,n,l){var o=t.defer();return(n?e.jsonp(r+"?callback=JSON_CALLBACK"):e.get(r)).success(function(e,t,i,a){o.resolve(e)}).error(function(e,t,l,u){return n?(i.error(i.codes.JSON_LOAD_ERROR,{uri:r}),void o.reject(r)):a(r,!0)}),o.promise}}]),angular.module("formula").factory("formulaLog",[function(){function e(e,t){var i=e,a=i.match(/\{[^\}]*\}/g);return angular.forEach(a,function(e,a){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}var t={FIELD_INVALID_ID:"field ID contains an illegal character: {character} ({field})",FIELD_MISSING_PROPERTY:"missing required field property: {property} ({field})",FIELD_UNSUPPORTED_FORMAT:"unsupported string format: {format} ({field})",FIELD_UNSUPPORTED_PROPERTY:"unsupported field property: {property} ({field})",FIELD_UNSUPPORTED_TOKEN:"unsupported default token: {token} ({field})",FIELD_UNSUPPORTED_TYPE:"unsupported field type: {type} ({field})",FIELD_HIDDEN_DEFAULT:"field hidden by default: {field}",I18N_MISSING_CODE:"missing ISO 639-3 language code: {uri}",JSON_LOAD_ERROR:"could not load JSON document: {uri}",SCHEMA_INVALID_URI:"invalid URI for schema deref: {uri}",SCHEMA_MISSING_PROPERTY:"missing required schema property: {property} ({schema})",SCHEMA_MISSING_REFERENCE:"missing schema reference: {schema}"};return{codes:t,debug:function(t,i){i?console.debug(e(t,i)):console.debug(t)},error:function(t,i){console.error(e(t,i))},warning:function(t,i){console.warn(e(t,i))}}}]),angular.module("formula").service("formulaModel",[function(){var e={data:{}};return e}]),angular.module("formula").factory("formulaSchema",["$q","formulaJsonLoader","formulaLog",function(e,t,i){function a(e){this.deferred=null,this.json=null,this.uri=e||null}return a.cache={},a.prototype={compile:function(){function e(e){if("#"===e[0]){e=e.substr("/"===e[1]?2:1).split("/");var t=r.json;return angular.forEach(e,function(e){t&&(t=t[e])}),t}return null}function t(i,r,n){var l,o=[];return angular.forEach(i,function(u,s){"object"==typeof u?o=o.concat(t(u,i,s)):"$ref"===s&&r&&("#"===u[0]?(l=e(u))?r[n]=l:(o.push(u),delete r[n]):a.cache[u]&&a.cache[u].json?r[n]=a.cache[u].json:(o.push(u),delete r[n]))}),o}var r=this,n=this.json?t(this.json):[this.uri];return n.length?(angular.forEach(n,function(e){i.warning(i.codes.SCHEMA_MISSING_REFERENCE,{schema:e})}),!1):!0},deref:function(r){var n=this;if(this.deferred=e.defer(),r&&"string"==typeof r)if(a.cache[r])a.cache[r].then(function(e){n.json=e,n.deferred.resolve(e)});else{var l={schema:a.cache[r]=new a(r),missing:null,resolve:function(e){if(e&&this.missing instanceof Array){var t=this.missing.indexOf(e);-1!==t&&this.missing.splice(t,1)}this.missing&&this.missing.length||(this.schema.compile(),n.json=this.schema.json,n.deferred.resolve(n.json))}};t(r).then(function(e){l.schema.json=e;var t=l.schema.missing(!1);t?(l.missing=angular.copy(t),angular.forEach(t,function(e){if(a.cache[e])a.cache[e].then(function(){l.resolve(e)});else{var t=new a;t.deref(e).then(function(){l.resolve(e)})}})):l.resolve()},function(e){n.deferred.reject(e)})}else i.warning(i.codes.SCHEMA_INVALID_URI,{uri:r}),this.deferred.reject("Invalid schema URI: "+r);return this},missing:function(e){function t(i){var r=[];return angular.forEach(i,function(i,n){if("object"==typeof i){var l=t(i);angular.forEach(l,function(e){r.push(e)})}else"$ref"===n&&"#"!==i[0]&&(e&&a.cache[i]||r.push(i))}),r}var i=t(this.json);return i.length?i:null},then:function(e){this.deferred?this.deferred.promise.then(function(t){e(t)},function(e){}):e(this.json)}},a}]),angular.module("formula").filter("formulaInlineValues",[function(){return function(e,t){var i=[];return angular.forEach(e,function(e){if(e.value instanceof Array)i.push("Array["+e.value.length+"]");else switch(typeof e.value){case"string":case"number":case"boolean":i.push(e.value)}}),i.join(", ")}}]),angular.module("formula").filter("formulaReplace",[function(){return function(e,t){var i=e,a=e.match(/\{[^\}]*\}/g);return angular.forEach(a,function(e,a){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}}]),angular.module("formula").service("formulaAutoCompleteService",["$http","$q",function(e,t){const i=/^(https?|\/\/)/,a="Invalid autocomplete source ";var r={},n={},l=function(e){return r[e]&&r[e].constructor===Function},o=function(e){return e.constructor===Object&&e.hasOwnProperty("source")&&e.hasOwnProperty("callback")},u=function(e){return e&&(i.test(e)||o(e)&&u(e.source))},s=function(e,t){r[e]=t},f=function(e,t){n[e]=t},d=function(e,t){return t&&"string"==typeof e[0]?e=e.filter(function(e){return 0===e.toLowerCase().indexOf(t.toLowerCase())}):e},c=function(n,o,u){var s=t.defer();if(i.test(o)){var f={params:{q:u||""}};e.get(o,f).then(function(e){s.resolve(c(n,e.data,u))},function(e){s.reject(new Error(a+o))})}else o.constructor!==Array&&(o=[]),l(n.path)?s.resolve(d(r[n.path].call(n,o),u)):s.resolve(d(o,u));return s.promise},m=function(e){e.source=[],e.onSelect=function(t){n[e.path]&&n[e.path].call(e,t)},e.querySearch=function(t){return c(e,e.autocomplete,t)}};return{bindSourceCallback:s,bindSelectCallback:f,getSource:c,isURI:u,initField:m}}]),angular.module("formula").service("formulaCustomTemplateService",["$templateCache","$templateRequest","$q",function(e,t,i){var a,r=function(e,t){if(e)for(var i in e)if(e[i].match&&e[i].match.call({},angular.copy(t)))return e[i];return null},n=function(a){var r=e.get(a);if(!r)return t(a,!1);var n=i.defer();return n.resolve(r),n.promise},l=function(e,t){var a=i.defer(),l=r(e,t);return l?l.hidden?a.resolve(!1):null!=l.template?""===l.template?a.resolve(!1):a.resolve(l.template):l.templateUrl?n(l.templateUrl).then(function(e){a.resolve(e)},function(){a.reject()}):a.reject():a.reject(),a.promise},o=function(e){a&&l(a,e).then(function(t){t?e.customTemplate=t:e.hidden=!0})},u=function(e){a=e};return{setTemplates:u,initField:o}}]),angular.module("formula").service("formulaEvaluateConditionsService",["$rootScope",function(e){var t={},i=function(e){e.fieldsets.forEach(function(e){e.fields.forEach(function(e){t[e.id]=e.value,a(e)})})},a=function(i){if(i.typeOf("array")?i.values.forEach(function(e){a(e)}):i.typeOf("object")&&i.fields.forEach(function(e){a(e)}),i.condition){var r=!0,n=i.condition instanceof Array?i.condition:[i.condition];if(n.forEach(function(a){if(r){"#"!==a[0]&&(a=i.path.substr(0,i.path.lastIndexOf("/")+1)+a),a=a.substr(2),a=a.replace(/\/(\d+)/g,"[$1]"),a=a.replace(/\//g,"."),a=a.replace("=","==").replace("===","==");var n=e.$eval(a,t);t&&void 0!==n&&n!==!1||(r=!1)}}),i.visible!==(i.visible=i.hidden?!1:r)){var l=i.value;i.value=i.backupValue,i.backupValue=l}}};return{evaluateConditions:i}}]),angular.module("formula").service("formulaFieldAttributesService",["$rootScope","formulaLog","formulaAutoCompleteService","formulaCustomTemplateService","formulaFieldTranslateDefaultsService","formulaFieldTypeService",function(e,t,i,a,r,n){var l=function(e,t){if("object"==typeof e){var i="autocomplete,condition,default,description,disabled,enum,format,hidden,maximum,maxLength,minimum,minLength,multiple,nullable,pattern,readonly,required,step,title,type,values".split(",");angular.forEach(t,function(e,t){-1!==i.indexOf(t)&&(this[t]=e)},e)}},o=function(t){t.typeOf("input")&&(t.destroyWatcher=e.$watch(function(){return t.value},function(i,a){if(i!==a){t.dirty=!0;for(var r=t.parents.length-1;r>=0;r--)t.parents[r].dirty=!0,t.parents[r].itemChange(t);e.$emit("revalidate")}},!0))},u=function(e,u){var s=u.schema,f=u.id,d=u.parents,c=u.fieldDefinition;e.parents=d||[],e.id=e.title=f,e.schema=s,e.fieldDefinition=c||{},l(e,s),l(e,c),e.required=e.schema.required&&-1!==e.schema.required.indexOf(e.id);var m=[".","/","#"];return angular.forEach(m,function(e){this.id&&this.id.indexOf(e)>=0&&t.warning(t.codes.FIELD_INVALID_ID,{character:e,field:this.path})},e),e.uidGen(),r.translateDefaultValues(e),n.setFieldType(e),e.typeOf("array")&&(e.value=[]),e.typeOf("object")&&(e.value={}),e.typeOf("select")&&(e.values=[],e["enum"].forEach(function(t){e.values.push({id:t,label:t})})),e.typeOf("array")&&e.schema.items&&e.fieldDefinition.fields&&l(e.items,e.fieldDefinition.fields[0]),(e.typeOf("array")||e.typeOf("object"))&&e.fieldAdd(),a.initField(e),e.pattern&&!e.schema.pattern&&(e.schema.pattern=e.pattern),e.typeOf("array")&&e.schema.minItems&&e.itemAdd(),e.id&&"_"===e.id[0]&&e.hidden!==!1&&(t.debug(t.codes.FIELD_HIDDEN_DEFAULT,{field:e.path}),e.hidden=!0),e.visible=e.hidden?!1:!0,e["default"]&&e.typeOf("array")&&(e["default"]instanceof Array||(e["default"]=[e["default"]])),void 0!==e["default"]&&(e.value=e["default"]),e.typeOf("select")&&!e.multiple&&null==e.value&&(e.value=e["enum"][0]),e.typeOf("autocomplete")&&i.initField(e),o(e),e};return{attrsSet:u}}]),angular.module("formula").service("formulaFieldTranslateDefaultsService",["$filter","formulaLog",function(e,t){var i=function(i){if("string"==typeof i["default"]){var a,r=i["default"].match(/^%(.*)%$/);if(r){switch(r[1]){case"date":a=e("date")(new Date,"yyyy-MM-dd","UTC");break;case"datetime":a=e("date")(new Date,"yyyy-MM-ddThh:mm:ss","UTC")+"Z";break;case"time":a=e("date")(new Date,"hh:mm:ss","UTC");break;case"year":a=e("date")(new Date,"yyyy","UTC");break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TOKEN,{token:r[1],field:i.path})}a&&(i["default"]=a)}}};return{translateDefaultValues:i}}]),angular.module("formula").service("formulaFieldTypeService",["$filter","formulaLog","formulaFormat",function(e,t,i){var a=function(e){e.type instanceof Array?(e.nullable=e.type.some(function(e){return"null"===e}),1===e.type.length?e.type=e.type[0]:2===e.type.length?"null"===e.type[0]?e.type=e.type[1]:"null"===e.type[1]&&(e.type=e.type[0]):(e.types=e.type,e.type="any"),e.mainType=e.type):e.mainType=e.schema.type},r=function(e){if(a(e),e.autocomplete)e.type="input:autocomplete";else if("select"===e.type||e["enum"])e.type="input:select";else if(e.format){var r=e.format.replace("-","");if(i[r]){switch(r){case"date":case"datetime":case"time":e.type="input:"+r;break;default:e.type="input:text"}tv4.addFormat(e.format,i[r])}else t.warning(t.codes.FIELD_UNSUPPORTED_FORMAT,{format:e.format,field:e.path}),e.type="input:text"}else switch(e.type){case"any":e.type="input:any";break;case"array":if(e.values=[],e.schema.items){var n=e.schema.items;"object"===n.type?e.type="array:fieldset":"array"===n.type?e.type="array:array":n["enum"]?(e["enum"]=n["enum"],e.multiple=!0,e.type="input:select"):n.allOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"allOf",field:e.path}):n.anyOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"anyOf",field:e.path}):n.oneOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"oneOf",field:e.path}):e.type="array:field",e.schema.minItems>=1&&(e.required=!0)}else t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"items",field:e.path}),e.type=null;break;case"boolean":case"checkbox":e.type="input:checkbox",e.value=!!e.value;break;case"integer":case"number":e.type="input:number";break;case"range":e.type="input:range";break;case"object":e.schema.properties||(t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"properties",field:e.path}),e.type=null);break;case"textarea":e.type="input:textarea";break;case"string":case"text":e.type="input:text";break;case void 0:e.type="input:text";break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TYPE,{type:e.type,field:e.path}),e.type=null}};return{setFieldType:r}}]),angular.module("formula").service("formulaFieldValidateService",[function(){var e=function(e,t){var i=t.silent,a=t.force;if(e.schema){var r,n;if((null===e.value||""===e.value)&&(e.value=void 0),!e.dirty&&!a||!e.required&&void 0===e.value||(n=tv4.validateMultiple(r||e.value,e.schema),e.valid=n.valid),!e.valid&&e.nullable){switch(typeof e.value){case"string":e.value&&e.value.length||(e.value=null);break;case"number":isNaN(e.value)&&(e.value=null);break;case"object":Object.keys(e.value).length||(e.value=null)}e.values&&!e.values.length&&(e.value=null),e.isEmpty()&&(e.valid=!0)}return!i&&n&&e.valid===!1?e.typeOf("array")||e.typeOf("object")?e.errors=n.errors:e.error=n.errors[0]:(e.error=null,e.errors=null),e.dirty=!1,e.valid!==!1}return!1};return{validate:e}}]),angular.module("formula").service("formulaFieldValueFromModelService",["formulaCustomTemplateService",function(e){var t=function(i,a){void 0!==a[i.id]&&("object"===i.type?i.fields.forEach(function(e,r){void 0!==a[i.id][e.id]&&t(e,a[i.id])}):i.typeOf("array")&&(i.values=[],a[i.id].forEach(function(e,a){var r;if(i.typeOf("fieldset")){if(r=i.itemAdd()){var n={};n[i.values[a].id]=e,t(i.values[a],n)}}else i.typeOf("field")&&(r=i.itemAdd(),r&&(i.values[a].value=e))},i)),i.value=a[i.id],i.dirty=!0,e.initField(i))};return{valueFromModel:t}}]),angular.module("formula").run(["$templateCache",function(e){e.put("formula/default.html",'<!DOCTYPE html><form class="formula" ng-if="form.fieldsets"><header ng-if="::form.title">{{ ::form.title }}</header><nav ng-if="::form.fieldsets.length > 1"><a href="" ng-class="{ active: fieldset.active }" ng-click="form.activate(fieldset)" ng-repeat="fieldset in ::form.fieldsets">{{ ::fieldset.title }}</a></nav><fieldset ng-if="fieldset.active" ng-repeat="fieldset in ::form.fieldsets"><legend ng-if="::fieldset.title">{{ fieldset.title }}</legend><div formula:field-definition="" ng-repeat="field in ::fieldset.fields" ng-show="field.visible"><div ng-class="{ valid: field.valid, error: field.error, required: (field.required && field.value == null) }" ng-if="::field.typeOf(\'input\')" title="{{ field.description }}"><label for="{{ ::field.uid }}">{{ field.title }}</label> <input formula:field="field"> <span>{{ field.error.message || field.description }}</span></div><div ng-if="::field.typeOf(\'object\')"><fieldset formula:field="field"><legend ng-if="::field.title">{{ field.title }}</legend><div ng-repeat="field in field.fields" ng-show="field.visible"><formula:field-instance field="field"></formula:field-instance></div></fieldset></div><div ng-if="::field.typeOf(\'array\')"><div formula:field="field"><fieldset ng-class="{ valid: field.valid, error: field.errors }"><legend>{{ field.title }} ({{ field.nrArrayValues() || 0 }})</legend><ul ng-if="::field.typeOf(\'fieldset\')"><li ng-if="!value.hidden" ng-repeat="value in field.values"><fieldset ng-class="{ valid: value.valid }"><legend><span ng-if="!value.visible">{{ value.fields | formulaInlineValues }}</span> <a class="toggle" href="" ng-click="field.itemToggle($index)" title="{{ value.visible ? form.i18n.minimize[1] : form.i18n.maximize[1] }}">{{ value.visible ? \'_\' : \'‾\' }}</a> <a class="remove" href="" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">X</a></legend><div ng-repeat="field in ::value.fields" ng-show="field.visible"><formula:field-instance field="field"></formula:field-instance></div></fieldset></li><li><span ng-if="field.errors" title="{{ field.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: field.errors.length } }}</span> <span ng-if="!field.errors">{{ field.description }}</span> <button class="add" ng-click="field.itemAdd()" title="{{ form.i18n.add[1] }}" type="button"><strong>+</strong> {{ form.i18n.add[0] }}</button></li></ul><ul ng-if="::field.typeOf(\'field\')"><li ng-class="{ valid: value.valid, error: value.error }" ng-repeat="value in field.values"><input formula:field="value"> <a class="remove" href="" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">X</a></li><li><span ng-if="field.errors" title="{{ field.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: field.errors.length } }}</span> <span ng-if="!field.errors">{{ field.description }}</span> <button class="add" ng-click="field.itemAdd()" title="{{ form.i18n.add[1] }}" type="button"><strong>+</strong> {{ form.i18n.add[0] }}</button></li></ul></fieldset></div></div></div></fieldset><footer><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: form.errors.length } }}</span> <button ng-click="form.validate(true);" ng-if="!data.hideButtons" title="{{ form.i18n.validate[1] }}"><strong>&#10003;</strong> {{ form.i18n.validate[0] }}</button> <button ng-click="form.save()" ng-disabled="!form.valid" ng-if="!data.hideButtons" title="{{ form.i18n.save[1] }}"><strong>&#9921;</strong> {{ form.i18n.save[0] }}</button></footer></form><div class="formula" ng-if="!form.fieldsets"><div class="loading"><div class="spinner"></div><span>Loading...</span></div></div>')}]);