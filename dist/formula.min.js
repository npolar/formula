angular.module("formula",[]),angular.module("formula").directive("formulaFieldDefinition",function(){return{restrict:"A",require:"^formula",compile:function(e,i){i.$set("formulaFieldDefinition");var t=e.html();return function(e,i,l,a){a.fieldDefinition=t}}}}),angular.module("formula").directive("formulaFieldInstance",["$compile",function(e){return{restrict:"AE",require:"^formula",scope:{field:"="},compile:function(){return function(i,t,l,a){var n=angular.element(a.fieldDefinition);e(n)(i),t.prepend(n)}}}}]),angular.module("formula").directive("formulaField",["$compile",function(e){return{restrict:"A",require:["^formula","?^formulaFieldInstance"],scope:{field:"=formulaField"},link:function(i,t,l,a){var n=i.field;i.form=a[0].form,i.backupValue=null,a[1]&&(i.field=a[1].field),l.$set("id",n.uid),l.$set("ngModel","field.value"),l.$set("formulaField"),n.disabled&&l.$set("disabled","disabled");var s=angular.element(t),r=n.type?n.type.split(":"):null;if(r=r?{main:r[0],sub:r[1]}:null,"input"==r.main){switch(r.sub){case"textarea":s=angular.element("<textarea>");break;case"select":s=angular.element("<select>"),t.children().length?angular.forEach(t.children(),function(e){s.append(e)}):s.attr("ng-options","value.id as value.label for value in field.values"),n.multiple&&s.attr("multiple","multiple");break;default:switch(s=angular.element("<input>"),s.attr("type",r.sub),r.sub){case"number":case"range":null!==n.step&&s.attr("step",n.step);break;case"any":s.attr("type","text")}}angular.forEach(l,function(e,i){l.$attr[i]&&s.attr(l.$attr[i],e)})}var d="formula-";angular.forEach(n.parents,function(e){d+=e.id+"/"}),n.id?d+=n.id:n.parents&&(d=d.substr(0,d.length-1)),s.addClass(d),e(s)(i),t.replaceWith(s),"input"==r.main?i.$watch("field.value",function(e){n.dirty||null===e||(n.dirty=!0),n.parents||n.validate(!0,!0)}):"object"==r.main?i.$watch("field.fields",function(){n.validate(!1,!0)},!0):"array"==r.main&&i.$watch("field.values",function(){n.validate(!1,!0)},!0),n.condition&&(i.model=a[0].model,i.$watchCollection("model",function(e){var t=!0,l=n.condition instanceof Array?n.condition:[n.condition];if(angular.forEach(l,function(l){var a,s=e,r=n.parents;if(t){"#"==l[0]&&(r=[],"/"==l[1]?a=l.substr(1).split("/"):(a=l.substr(1).split("."),a[0].length||r.splice(0,1)),angular.forEach(a,function(e,i){isNaN(e)?r.push({id:e,index:null}):i>0&&(r[i-1].index=Number(e))}),l=r[r.length-1].id,r.splice(r.length-1,1)),angular.forEach(r,function(e){s&&(s=null!==e.index?s[e.index][e.id]:s[e.id])}),s&&null!==n.index&&(s=s[n.index]);var d=i.$eval(l,s);s&&void 0!==d&&d!==!1||(t=!1)}}),n.visible!=(n.visible=n.hidden?!1:t)){var a=n.value;n.value=i.backupValue,i.backupValue=a}}))},terminal:!0}}]),angular.module("formula").directive("formula",["formulaJsonLoader","formulaSchema","formulaForm","formulaI18n","$http","$compile","$templateCache",function(e,i,t,l,a,n,s){return{restrict:"A",scope:{data:"=formula"},controller:["$scope","$attrs","$element",function(a,r,d){function f(e){(!u.pending||e)&&a.schema.then(function(i){i&&(u.pending=!1,o.form=a.form=new t(a.model,e),a.form.build(i,u.data),a.form.translate(a.language.code))})}var o=this,u={pending:!1,data:null};o.model=a.model=a.data.model||{},o.schema=a.schema=new i,o.form=a.form=new t(a.data.model),a.template=a.data.template||"default",a.language={uri:a.data.language||null,code:null},a.$watch("data.form",function(i){i?(u.pending=!0,e(i).then(function(e){u.data=e,f(i)})):(u.data=null,f(null))}),a.$watch("data.schema",function(e){(a.schema.uri=e)&&a.schema.deref(e).then(function(){f()})}),a.$watch("data.template",function(e){var i,t=e||"";".html"!=t.substr(0,-5)&&(t+=".html"),(i=s.get(t))||(i=s.get("default.html")),"FORM"==d.prop("tagName")?(d.empty(),d.append(i.children()),n(d.children())(a)):(d.empty(),d.prepend(i),n(d.children())(a))}),a.$watch("data.language",function(e){var i=l.code(e);e&&!i?l.add(e).then(function(e){a.language.code=e,a.form.translate(e)}):(a.language.code=i,a.form.translate(i))}),a.$watch("data.model",function(e){o.model=a.model=e,f()},!0)}]}}]),angular.module("formula").factory("formulaField",["$filter","formulaLog","formulaFormat",function(e,i,t){function l(e,t,l){if("object"==typeof e){this.form=null,this.id=t||e.id||null,this.index=null,this.nullable=e.nullable||!1,this.parents=l||null,this.path=null,this.schema=e.schema||e;var a=[".","/","#"];angular.forEach(a,function(e){this.id&&this.id.indexOf(e)>=0&&i.warning(i.codes.FIELD_INVALID_ID,{character:e,field:this.path})},this),this.uidGen(),this.pathGen(),this.attrsSet(e)}}return l.uids=[],l.prototype={attrsSet:function(l){var a="condition,default,description,disabled,enum,format,hidden,maximum,maxLength,minimum,minLength,multiple,pattern,required,step,title,values".split(",");if(angular.forEach(l,function(e,i){-1!=a.indexOf(i)&&(this[i]=e)},this),"string"==typeof this.default){var n,s=this.default.match(/^%(.*)%$/);if(s){switch(s[1]){case"date":n=e("date")(new Date,"yyyy-MM-dd","UTC");break;case"datetime":n=e("date")(new Date,"yyyy-MM-ddThh:mm:ss","UTC")+"Z";break;case"time":n=e("date")(new Date,"hh:mm:ss","UTC");break;default:i.warning(i.codes.FIELD_UNSUPPORTED_TOKEN,{token:s[1],field:this.path})}n&&(this.default=n)}}if(this.fields&&l.fields){var r=[];angular.forEach(l.fields,function(e){if("object"==typeof e){var i=this.fieldFromID(e.id);i&&(r.push(e.id),i.attrsSet(e))}else"string"==typeof e&&r.push(e)},this);for(var d in this.fields)-1==r.indexOf(this.fields[d].id)&&this.fields.splice(d,1)}if(l.type instanceof Array&&(1==l.type.length?l.type=l.type[0]:2==l.type.length&&("null"==l.type[0]?(l.type=l.type[1],this.nullable=!0):"null"==l.type[1]&&(l.type=l.type[0],this.nullable=!0))),"select"==l.type||l.enum)this.type="input:select",this.multiple=!!l.multiple;else if(this.format){var f=this.format.replace("-","");if(t[f]){switch(f){case"date":case"datetime":case"time":this.type="input:"+f;break;default:this.type="input:text"}tv4.addFormat(this.format,t[f])}else i.warning(i.codes.FIELD_UNSUPPORTED_FORMAT,{format:this.format,field:this.path}),this.type="input:text"}else switch(l.type){case"any":case"input:any":this.type="input:any";break;case"array":case"array:field":case"array:fieldset":l.items?("object"==l.items.type?(this.type="array:fieldset",this.fieldAdd(l.items)):l.items.enum?(this.enum=l.items.enum,this.multiple=!0,this.type="input:select"):l.items.allOf?i.warning(i.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"allOf",field:this.path}):l.items.anyOf?i.warning(i.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"anyOf",field:this.path}):l.items.oneOf?i.warning(i.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"oneOf",field:this.path}):(this.type="array:field",this.fieldAdd(l.items)),l.minItems>=1&&(this.required=!0)):l.fields?(this.type=l.type,this.fields=l.fields):(i.warning(i.codes.FIELD_MISSING_PROPERTY,{property:"items",field:this.path}),this.type=null);break;case"boolean":case"checkbox":case"input:checkbox":this.type="input:checkbox";break;case"input:number":case"integer":case"number":this.step=l.step||null,this.type="input:number";break;case"input:range":case"range":this.step=l.step||null,this.type="input:range";break;case"object":l.properties?(this.type="object",this.fieldAdd(l)):l.fields?(this.type="object",this.fields=l.fields):(i.warning(i.codes.FIELD_MISSING_PROPERTY,{property:"properties",field:this.path}),this.type=null);break;case"input:textarea":case"textarea":this.type="input:textarea";break;case"input:text":case"string":case"text":this.type="input:text";break;case void 0:this.type=this.type||"input:text";break;default:i.warning(i.codes.FIELD_UNSUPPORTED_TYPE,{type:l.type,field:this.path}),this.type=null}return this.pattern&&this.schema&&!this.schema.pattern&&(this.schema.pattern=this.pattern),this.typeOf("array")&&this.schema.minItems&&(this.values||this.itemAdd()),this.id&&"_"==this.id[0]&&this.hidden!==!1&&(i.debug(i.codes.FIELD_HIDDEN_DEFAULT,{field:this.path}),this.hidden=!0),this.visible=this.hidden?!1:!0,(!this.value||l.value)&&(this.value=l.value||this.default||null),this.default&&"array"==l.type&&(this.default instanceof Array||(this.default=[this.default])),"input:select"!=this.type||this.multiple||null!==this.value||(this.value=this.enum[0]),this.dirty=null!==this.value,this},fieldAdd:function(e){if("object"==typeof e){this.fields||(this.fields=[]);var i=[];if(angular.forEach(this.parents,function(e){i.push(e)}),i.push({id:this.id,index:this.index}),"object"==e.type)angular.forEach(e.properties,function(t,a){var n=new l(t,a,i);n.required=e.required&&-1!=e.required.indexOf(a),n.type&&(n.index=this.fields.length,this.fields.push(n))},this);else{var t=new l(e,null,i);t.index=this.fields.length,this.fields.push(t)}return!0}return!1},fieldFromID:function(e){var i=null;return angular.forEach(this.fields,function(t){i||t.id!=e||(i=t)}),i},itemAdd:function(){if(this.typeOf("array")&&this.fields){this.values||(this.values=[]);var e=[];if(angular.forEach(this.parents,function(i){e.push(i)}),e.push({id:this.id,index:this.index}),this.typeOf("fieldset")){var i=this.values.push(angular.copy(this.fields));angular.forEach(this.values[i-1],function(t){t.index=i-1,t.parents=e,t.uidGen(),t.pathGen()})}else{var t=this.values.push(angular.copy(this.fields[0])),l=this.values[t-1];l.index=t-1,l.parents=e,l.uidGen(),l.pathGen()}this.validate(!0,!1)}},itemRemove:function(e){this.typeOf("array")&&this.values&&(this.values.length>e&&this.values.splice(e,1),angular.forEach(this.values,function(e,i){this.typeOf("fieldset")?angular.forEach(e,function(e){e.index=i,e.pathGen()}):(l.index=i,l.pathGen())},this))},itemIndex:function(e){for(var i in this.fields)if(this.fields[i].id==e)return i;return-1},pathGen:function(){this.path="#/",angular.forEach(this.parents,function(e){null!==e.index&&(this.path+=e.index+"/"),this.path+=e.id+"/"},this),null!==this.index?(this.path+=this.index,this.id&&(this.path+="/"+this.id)):this.id&&(this.path+=this.id)},typeOf:function(e){if(this.type&&"string"==typeof e){var i=this.type.split(":"),t=!1;return angular.forEach(e.split(" "),function(e){(!t&&e===this.type||e===i[0]||e===i[1])&&(t=!0)},this),t}return!1},uidGen:function(e){for(var i="formula-",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a=0;(e?e:8)>a;++a)i+=t[Math.floor(Math.random()*t.length)];return-1!=l.uids.indexOf(i)?this.uidGen(e):(this.uid=i,i)},validate:function(e,i){if(this.schema){var t,l,a=null;switch(this.type){case"array:field":this.value=[],angular.forEach(this.values,function(e){e.dirty&&e.validate()&&this.value.push(e.value)},this);break;case"array:fieldset":this.value=[],angular.forEach(this.values,function(i,t){this.value.push({}),angular.forEach(i,function(i){(i.dirty||null!==i.value||i.typeOf("array object"))&&i.validate(e,!1)&&(this.value[t][i.id]=i.value)},this)},this);for(var n=0;n<this.value.length;++n)tv4.validate([this.value[n]],this.schema)||(this.value.splice(n--,1),a=tv4.error);break;case"input:any":if(this.value)if(isNaN(this.value))if(l=this.value.match(/^\[(.*)\]$/))t=[l[1]];else switch(this.value.toLowerCase()){case"true":t=!0;break;case"false":t=!1;break;case"null":t=null}else t=Number(this.value);break;case"input:checkbox":this.value=!!this.value;break;case"input:integer":case"input:number":case"input:range":t=null===this.value?0/0:Number(this.value);break;case"input:select":if(this.multiple&&!this.value)this.value=[];else switch(this.schema.type){case"integer":case"number":this.value=Number(this.value)}break;case"object":this.value={},this.fields&&angular.forEach(this.fields,function(e){(null!==e.value||e.typeOf("array object"))&&e.validate()&&(this.value[e.id]=e.value)},this)}var s=tv4.validate(void 0!==t?t:this.value,this.schema);if(!s&&this.nullable){switch(typeof this.value){case"string":this.value&&this.value.length||(this.value=null);break;case"number":isNaN(this.value)&&(this.value=null);break;case"object":var r=0;angular.forEach(this.value,function(){r++}),r||(this.value=null)}null===this.value&&(a=null,s=!0)}return e!==!0&&(this.valid=s&&!a,this.error=a?a.message:s?null:tv4.error.message),i===!0&&this.form&&this.form.validate(!0),s}return!1},valueFromModel:function(e){if(e[this.id]){var i,t;if("object"==this.type)for(i in this.fields)e[this.id][this.fields[i].id]&&(this.fields[i].value=e[this.id][this.fields[i].id]);else if("array:fieldset"==this.type){this.values=[];for(i in e[this.id]){this.itemAdd();for(t in this.values[i])this.values[i][t].valueFromModel(e[this.id][i])}}else if("array:field"==this.type){this.values=[];for(i in e[this.id])this.itemAdd(),this.values[i].value=e[this.id][i]}else this.value=e[this.id]}}},l}]),angular.module("formula").factory("formulaForm",["formulaJsonLoader","formulaField","formulaI18n",function(e,i,t){function l(e,t){if(t&&"object"==t.type){var l=[];return angular.forEach(t.properties,function(a,n){var s=new i(a,n);s.form=e,s.required=s.required||t.required&&-1!=t.required.indexOf(n),e&&e.model&&s.valueFromModel(e.model),l.push(s)}),l}return null}function a(e,i){this.errors=null,this.fieldsets=null,this.i18n=t(null),this.model=e,this.schema=null,this.title=null,this.uri=i||null,this.valid=!1}return a.prototype={activate:function(e){angular.forEach(this.fieldsets,function(i,t){("object"==typeof e||"number"==typeof e)&&(i.active=("object"==typeof e?i===e:t===e)?!0:!1)})},build:function(e,t){if("object"==typeof e){var a=l(this,e);a.fieldExtended=function(e){for(var t=0;t<this.length;++t){var l="object"==typeof e;if(this[t].id==(l?e.id:e)){if(l){var a=new i(this[t]);return a.attrsSet(e)}return new i(this[t])}}return null},t&&t.fieldsets?(this.title=t.title,this.fieldsets=[],angular.forEach(t.fieldsets,function(e,i){this.fieldsets.push({title:e.title,active:i?!1:!0,fields:[]}),angular.forEach(e.fields,function(e){var t=a.fieldExtended(e);t&&(t.form=this,this.fieldsets[i].fields.push(t))},this)},this)):this.fieldsets=[{fields:a,active:!0}],this.schema=e,this.validate(!0)}},save:function(e,i){(i===!1||this.validate())&&(e?e(this.model):window.open("data:application/json,"+JSON.stringify(this.model)))},translate:function(e){function i(e,t){var l=t&&t.fields?t.fields[e.id]||null:null;("array:fieldset"==e.type||"object"==e.type)&&(angular.forEach(e.fields,function(e){i(e,l)}),angular.forEach(e.values,function(e){angular.forEach(e,function(e){i(e,l)})})),l?(e.title=l.title||e.title||e.id,e.description=l.description||e.description,e.typeOf("select")&&(e.values=[],angular.forEach(e.enum,function(i,t){e.values.push({id:i,label:l.values?l.values[t]||i:i})}))):(e.title=e.title||e.id,e.typeOf("select")&&(e.values=[],angular.forEach(e.enum,function(i){e.values.push({id:i,label:i})})))}this.i18n=t(e),angular.forEach(this.fieldsets,function(e,t){this.i18n.fieldsets&&(e.title=this.i18n.fieldsets[t]||e.title),angular.forEach(e.fields,function(e){i(e,this.i18n)},this)},this)},validate:function(e){function i(l){return l.typeOf("array")?angular.forEach(l.values,function(e){l.typeOf("fieldset")?angular.forEach(e,function(e){i(e)}):i(e)}):l.typeOf("object")&&angular.forEach(l.fields,function(e){i(e)}),l.typeOf("array checkbox object select")||l.required||l.dirty||null!==l.value?l.validate(l.dirty?!1:e,!1)?!0:(t.errors.push(l.path+" ("+tv4.error.message+")"),!1):null}var t=this;return this.errors=[],angular.forEach(this.fieldsets,function(e){angular.forEach(e.fields,function(e){var t=i(e);null!==t&&(this.model&&t?this.model[e.id]=e.value:this.model&&delete this.model[e.id])},this)},this),(this.valid=!this.errors.length)&&(this.errors=null),this.valid}},a}]),angular.module("formula").factory("formulaFormat",function(){return{color:function(e){var i="aqua,black,blue,fuchsia,gray,green,lime,maroon,navy,olive,orange,purple,red,silver,teal,white,yellow";return"string"!=typeof e||-1==i.split(",").indexOf(e.toLowerCase())&&!/^(#([a-f0-9]{3}|[a-f0-9]{6})|rgb\(\s?\d{1,3}%?,\s?\d{1,3}%?,\s?\d{1,3}%?\s?\))$/i.test(e)?"CSS 2.1 color":null},date:function(e){return"string"==typeof e&&/^\d{4}(-\d{2}){2}$/.test(e)?null:"ISO 8601 date"},datetime:function(e){return"string"==typeof e&&/^\d{4}(-\d{2}){2}T\d{2}(:\d{2}){2}(.\d+)?(([+-](\d{2}|\d{4}|\d{2}:\d{2}))|Z)$/.test(e)?null:"ISO 8601 datetime"},email:function(e){var i=/^[-+a-z0-9!#$%&'*=?^_`{|}~\/]([-+a-z0-9!#$%&'*=?^_`{|}~\/]|\.(?!\.)){0,62}[-+a-z0-9!#$%&'*=?^_`{|}~\/]$/i,t=/^[-a-z0-9]([-a-z0-9]|\.(?!\.)){0,253}[-a-z0-9]$/i,l=/\(.*\)/g,a="string"==typeof e?e.split("@"):[];return 2==a.length&&e.length<=254&&i.test(a[0].replace(l,""))&&t.test(a[1].replace(l,""))?null:"RCF 3696 e-mail address"},time:function(e){return"string"==typeof e&&/^\d{2}(:\d{2}){2}$/.test(e)?null:"ISO 8601 time"},uri:function(e){return"string"==typeof e&&/^([a-z][a-z0-9+.-]*):(?:\/\/((?:(?=((?:[a-z0-9-._~!$&'()*+,;=:]|%[0-9A-F]{2})*))(\3)@)?(?=(\[[0-9A-F:.]{2,}\]|(?:[a-z0-9-._~!$&'()*+,;=]|%[0-9A-F]{2})*))\5(?::(?=(\d*))\6)?)(\/(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\8)?|(\/?(?!\/)(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\10)?)(?:\?(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\11)?(?:#(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\12)?$/i.test(e)?null:"RFC 3986 URI"}}}),angular.module("formula").factory("formulaI18n",["formulaJsonLoader","formulaLog","$q",function(e,i,t){function l(e){return e&&l.cache[e]?l.cache[e]:{add:["Add","Click to add a new item"],invalid:"{count} invalid fields",remove:["Remove","Click to remove item"],required:"Required field",save:["Save","Click to save document"],validate:["Validate","Click to validate form"],code:null,fields:{},fieldsets:[],uri:null}}return l.cache={},l.add=function(a){var n=t.defer();return a?e(a).then(function(e){var t=e["iso639-3"];t?(l.cache[t]={code:t,fields:e.fields,fieldsets:e.fieldsets,uri:a},angular.forEach(e.labels,function(e,i){l.cache[t][i]=e}),n.resolve(t)):i.warning(i.codes.I18N_MISSING_CODE,{uri:a})}):n.reject("not a valid translation JSON URI: "+a),n.promise},l.code=function(e){var i=null;return angular.forEach(l.cache,function(t,l){i||t.uri!=e||(i=l)}),i},l}]),angular.module("formula").factory("formulaJsonLoader",["$http","$q",function(e,i){return function(t,l){var a=i.defer();return void 0===l&&(l=0===t.search(/https?:/)),(l?e.jsonp(t+"?callback=JSON_CALLBACK"):e.get(t)).success(function(e){a.resolve(e)}).error(function(){a.reject("Could not load JSON from "+t)}),a.promise}}]),angular.module("formula").factory("formulaLog",["$log",function(e){function i(e,i){var t=e,l=t.match(/\{[^\}]*\}/g);return angular.forEach(l,function(e){t=t.replace(e,i[e.substr(1,e.length-2)])}),t}var t={FIELD_INVALID_ID:"field ID contains an illegal character: {character} ({field})",FIELD_MISSING_PROPERTY:"missing required field property: {property} ({field})",FIELD_UNSUPPORTED_FORMAT:"unsupported string format: {format} ({field})",FIELD_UNSUPPORTED_PROPERTY:"unsupported field property: {property} ({field})",FIELD_UNSUPPORTED_TOKEN:"unsupported default token: {token} ({field})",FIELD_UNSUPPORTED_TYPE:"unsupported field type: {type} ({field})",FIELD_HIDDEN_DEFAULT:"field hidden by default: {field}",I18N_MISSING_CODE:"missing ISO 639-3 language code: {uri}",SCHEMA_INVALID_URI:"invalid URI for schema deref: {uri}",SCHEMA_MISSING_PROPERTY:"missing required schema property: {property} ({schema})",SCHEMA_MISSING_REFERENCE:"missing schema reference: {schema}"};return{codes:t,debug:function(t,l){e.debug(l?i(t,l):t)},error:function(t,l){e.error(i(t,l))},warning:function(t,l){e.warn(i(t,l))}}}]),angular.module("formula").factory("formulaSchema",["$q","formulaJsonLoader","formulaLog",function(e,i,t){function l(e){this.deferred=null,this.json=null,this.uri=e||null}return l.cache={},l.prototype={compile:function(){function e(e){if("#"==e[0]){e=e.substr("/"==e[1]?2:1).split("/");var i=a.json;return angular.forEach(e,function(e){i&&(i=i[e])}),i}return null}function i(t,a,n){var s,r=[];return angular.forEach(t,function(d,f){"object"==typeof d?r=r.concat(i(d,t,f)):"$ref"==f&&a&&("#"==d[0]?(s=e(d))?a[n]=s:(r.push(d),delete a[n]):l.cache[d]&&l.cache[d].json?a[n]=l.cache[d].json:(r.push(d),delete a[n]))}),r}var a=this,n=this.json?i(this.json):[this.uri];return n.length?(angular.forEach(n,function(e){t.warning(t.codes.SCHEMA_MISSING_REFERENCE,{schema:e})}),!1):!0},deref:function(a){var n=this;if(this.deferred=e.defer(),a&&"string"==typeof a)if(l.cache[a])l.cache[a].then(function(e){n.json=e,n.deferred.resolve(e)});else{var s={schema:l.cache[a]=new l(a),missing:null,resolve:function(e){if(e&&this.missing instanceof Array){var i=this.missing.indexOf(e);-1!=i&&this.missing.splice(i,1)}this.missing&&this.missing.length||(this.schema.compile(),n.json=this.schema.json,n.deferred.resolve(n.json))}};i(a).then(function(e){s.schema.json=e;var i=s.schema.missing(!1);i?(s.missing=angular.copy(i),angular.forEach(i,function(e){if(l.cache[e])l.cache[e].then(function(){s.resolve(e)});else{var i=new l;i.deref(e).then(function(){s.resolve(e)})}})):s.resolve()},function(e){n.deferred.reject(e)})}else t.warning(t.codes.SCHEMA_INVALID_URI,{uri:a}),this.deferred.reject("Invalid schema URI: "+a);return this},missing:function(e){function i(t){var a=[];return angular.forEach(t,function(t,n){if("object"==typeof t){var s=i(t);angular.forEach(s,function(e){a.push(e)})}else"$ref"==n&&"#"!=t[0]&&(e&&l.cache[t]||a.push(t))}),a}var t=i(this.json);return t.length?t:null},then:function(e){this.deferred?this.deferred.promise.then(function(i){e(i)},function(){}):e(this.json)}},l}]),angular.module("formula").filter("formulaReplace",function(){return function(e,i){var t=e,l=e.match(/\{[^\}]*\}/g);return angular.forEach(l,function(e){t=t.replace(e,i[e.substr(1,e.length-2)])}),t}}),angular.module("formula").run(["$templateCache",function(e){e.put("bootstrap3.html",'<form class="form-horizontal" ng-if="form.fieldsets"><header ng-if="form.title" class="page-header" style="margin-top: -10px"><h2>{{ form.title }}</h2></header><ul class="nav nav-tabs"><li ng-repeat="fieldset in form.fieldsets" ng-if="form.fieldsets.length > 1" ng-class="{ active: fieldset.active }"><a href="" ng-click="form.activate(fieldset)">{{ fieldset.title }}</a></li></ul><fieldset ng-repeat="fieldset in form.fieldsets" ng-if="fieldset.active" style="border: 1px solid #ddd; border-radius: 0 0 5px 5px; border-top: 0; padding: 15px; padding-bottom: 0;"><div ng-repeat="field in fieldset.fields" ng-show="field.visible" formula:field-definition=""><div ng-if="field.typeOf(\'input\')" title="{{ field.description }}" class="form-group has-feedback"><label for="{{ field.uid }}" class="col-sm-3 control-label">{{ field.title }}</label><div class="col-sm-9" ng-class="{ \'has-error\': field.error, \'has-success\': field.valid, \'has-warning\': (field.required && field.value === null) }"><div ng-if="!field.typeOf(\'select\')"><input class="form-control input-md" formula:field="field"><div ng-if="!field.typeOf(\'checkbox\') && (field.error || field.valid)"><span ng-if="field.valid" class="glyphicon glyphicon-ok form-control-feedback"></span> <span ng-if="field.error" class="glyphicon glyphicon-remove form-control-feedback"></span></div></div><select ng-if="field.typeOf(\'select\')" class="form-control input-md" formula:field="field"><option ng-repeat="value in field.values" value="{{ value.id }}">{{ value.label }}</option></select><span class="help-block">{{ field.error || field.description }}</span></div></div><div ng-if="field.typeOf(\'object\')"><div class="panel" ng-class="{ \'panel-danger\': field.error, \'panel-success\': field.valid }" formula:field="field"><div class="panel-heading">{{ field.title }}</div><div class="panel-body"><div ng-repeat="field in field.fields" ng-show="field.visible"><formula:field-instance field="field"></formula:field-instance></div></div></div></div><div ng-if="field.typeOf(\'array\')"><div formula:field="field"><div ng-if="field.typeOf(\'fieldset\')" class="panel" ng-class="{ \'panel-danger\': field.error, \'panel-success\': field.valid }"><div class="panel-heading">{{ field.title }}</div><ul class="list-group"><li class="list-group-item" ng-repeat="value in field.values"><fieldset><legend style="border: none; margin-bottom: 10px;"><button class="btn btn-sm btn-danger pull-right" ng-click="field.itemRemove($index)" type="button" title="{{ form.i18n.remove[1] }}">X</button></legend><div ng-repeat="field in field.fields" ng-show="field.visible"><formula:field-instance field="value[$index]"></formula:field-instance></div></fieldset></li></ul><div class="panel-footer clearfix has-feedback" ng-class="{ \'has-error\': field.error, \'has-success\': field.valid }"><span class="help-block"><span>{{ field.error || field.description }}</span> <button class="btn btn-sm btn-primary pull-right" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}">{{ form.i18n.add[0] }}</button></span></div></div><div ng-if="field.typeOf(\'field\')" class="panel" ng-class="{ \'panel-danger\': field.error, \'panel-success\': field.valid }"><div class="panel-heading">{{ field.title }}</div><ul class="list-group"><li class="list-group-item" ng-repeat="value in field.values"><div class="input-group"><input formula:field="value" class="form-control input-md"> <span class="input-group-btn"><button class="btn btn-danger" ng-click="field.itemRemove($index)" type="button" title="{{ form.i18n.remove[1] }}">X</button></span></div></li></ul><div class="panel-footer clearfix has-feedback" ng-class="{ \'has-error\': field.error, \'has-success\': field.valid }"><span class="help-block"><span>{{ field.error || field.description }}</span> <button class="btn btn-sm btn-primary pull-right" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}">{{ form.i18n.add[0] }}</button></span></div></div></div></div></div></fieldset><div class="has-feedback" ng-class="{ \'has-error\': !form.valid, \'has-success\': form.valid }" style="margin-top: 10px;"><span class="help-block"><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: form.errors.length } }}</span><div class="btn-group pull-right"><button type="button" class="btn btn-info" ng-click="form.validate()" title="{{ form.i18n.validate[1] }}">{{ form.i18n.validate[0] }}</button> <button type="button" class="btn btn-success" ng-class="{ disabled: !form.valid }" ng-click="form.save()" title="{{ form.i18n.save[1] }}">{{ form.i18n.save[0] }}</button></div></span></div></form><div ng-if="!form.fieldsets" class="alert alert-info" style="text-align: center; overflow: hidden;"><span>Loading schema...</span></div>'),e.put("default.html",'<form class="formula" ng-if="form.fieldsets"><header ng-if="form.title">{{ form.title }}</header><nav ng-if="form.fieldsets.length > 1"><a ng-repeat="fieldset in form.fieldsets" ng-class="{ active: fieldset.active }" href="" ng-click="form.activate(fieldset)">{{ fieldset.title }}</a></nav><fieldset ng-repeat="fieldset in form.fieldsets" ng-if="fieldset.active"><legend ng-if="fieldset.title">{{ fieldset.title }}</legend><div ng-repeat="field in fieldset.fields" ng-show="field.visible" formula:field-definition=""><div ng-if="field.typeOf(\'input\')" title="{{ field.description }}" ng-class="{ valid: field.valid, error: field.error, required: (field.required && !field.valid && !field.error) }"><label for="{{ field.uid }}">{{ field.title }}</label> <input formula:field="field"> <span>{{ field.error || field.description }}</span></div><div ng-if="field.typeOf(\'object\')"><fieldset formula:field="field"><legend>{{ field.title }}</legend><div ng-repeat="field in field.fields" ng-show="field.visible"><formula:field-instance field="field"></formula:field-instance></div></fieldset></div><div ng-if="field.typeOf(\'array\')"><div formula:field="field"><fieldset ng-class="{ valid: field.valid, error: field.error }"><legend>{{ field.title }}</legend><ul ng-if="field.typeOf(\'fieldset\')"><li ng-repeat="value in field.values"><fieldset><legend><a href="" class="remove" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">X</a></legend><div ng-repeat="subfield in field.fields" ng-show="value[$index].visible"><formula:field-instance field="value[$index]"></formula:field-instance></div></fieldset></li><li><span>{{ field.error || field.description }}</span> <button class="add" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}"><strong>+</strong> {{ form.i18n.add[0] }}</button></li></ul><ul ng-if="field.typeOf(\'field\')"><li ng-repeat="value in field.values" ng-class="{ valid: value.valid, error: value.error }"><input formula:field="value"> <a href="" class="remove" ng-click="field.itemRemove($index)" title="{{ form.i18n.remove[1] }}">X</a> <span ng-if="value.error">{{ value.error }}</span></li><li><span>{{ field.error || field.description }}</span> <button class="add" ng-click="field.itemAdd()" type="button" title="{{ form.i18n.add[1] }}"><strong>+</strong> {{ form.i18n.add[0] }}</button></li></ul></fieldset></div></div></div></fieldset><footer><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ form.i18n.invalid | formulaReplace : { count: form.errors.length } }}</span> <button ng-click="form.validate()" title="{{ form.i18n.validate[1] }}"><strong>&#10003;</strong> {{ form.i18n.validate[0] }}</button> <button ng-disabled="!form.valid" ng-click="form.save()" title="{{ form.i18n.save[1] }}"><strong>&#9921;</strong> {{ form.i18n.save[0] }}</button></footer></form><div class="formula" ng-if="!form.fieldsets"><div class="loading"><div class="spinner"></div><span>Loading schema</span></div></div>')}]);