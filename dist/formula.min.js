!function(){"use strict";angular.module("formula",[])}(),angular.module("formula").directive("formulaField",["$compile","formulaClassService","formulaI18n",function(e,t,i){"use strict";return{restrict:"AE",scope:{field:"="},link:function(r,a,n){var l=r.field;a.addClass(t.pathClass(l)),a.addClass(t.schemaClass(l)),l.required&&a.addClass("required"),r.i18n=i,r.$watch("field.template",function(t){!l.hidden&&l.template?(a.html(l.template),e(a.contents())(r),l._elem_q.resolve(a)):l._elem_q.reject(a)})}}}]),angular.module("formula").directive("formulaFields",["$compile","formulaClassService","formulaI18n",function(e,t,i){"use strict";return{restrict:"AE",scope:{fields:"="},compile:function(t,r){if(t.html()){var a=t.html();t.empty()}return function(t,r,n){t.i18n=i,t.fields.forEach(function(i){var n=t.$new();n.field=i,n.parent=i.parents[i.parents.length-1];var l=a||'<formula:field field="field"></formula:field>';!i.hidden&&l&&e(l)(n,function(e,t){r.append(e)})})}}}}]),angular.module("formula").directive("formulaFieldsets",["$compile","formulaClassService","formulaDirtyCheckService",function(e,t,i){"use strict";return{restrict:"AE",require:"?^^form",link:function(r,a,n,l){r.form.fieldsets.forEach(function(n){var o=n.template;if(!n.hidden&&o){var s=r.$new(),u=angular.element(o);s.fieldset=n,u.addClass(t.schemaClass(n)),e(u)(s,function(e,t){a.append(e)}),l&&(l.$setPristine(),i.setForm(l))}})}}}]),angular.module("formula").directive("formula",["$compile","$timeout","formulaI18n","formulaClassService",function(e,t,i,r){"use strict";return{restrict:"AE",scope:{options:"="},controller:["$scope",function(e){if(!e.options)throw"No formula options provided!";var r={setLanguage:function(i){e.language=i,this.form&&this.form.translate(),t()},setForm:function(t){e.form=this.form=t}},a=function(){r.setForm(e.options.form),r.setLanguage(i.code),e.options.controller=r,e.i18n=i};a()}],link:function(i,a,n){i.$watch("form",function(n){if(n){a.addClass(r.schemaClass(n)),a.html(n.template),e(a.contents())(i);var l,o=i.$watch(function(){clearTimeout(l),l=setTimeout(function(){o(),t(function(){i.form.ready=!0},100)},50)})}})}}}]),angular.module("formula").directive("formulaInput",["$compile",function(e){"use strict";var t=function(e,t,i){var r;switch(t.sub){case"textarea":r=angular.element("<textarea>"),r.attr("md-detect-hidden",!0);break;case"select":r=angular.element("<select>"),i.children().length?angular.forEach(i.children(),function(e){r.append(e)}):r.attr("ng-options","value.id as value.label for value in field.values"),e.multiple&&r.attr("multiple","multiple");break;default:switch(r=angular.element("<input>"),r.attr("type",t.sub),t.sub){case"number":case"range":null!==e.step&&r.attr("step",e.step);break;case"any":case"date":case"datetime":case"time":r.attr("type","text")}}return r},i=function(e){var t=e.type?e.type.split(":"):null;return t=t?{main:t[0],sub:t[1]}:null},r=function(e){e.$set("id","{{field.uid}}"),e.$set("ngModel","field.value"),e.$set("ng-disabled","field.disabled"),e.$set("ng-readonly","field.readonly")},a=function(e,r,a){var n=e.field,l=i(n),o=t(n,l,r);return angular.forEach(a,function(e,t){a.$attr[t]&&o.attr(a.$attr[t],e)}),o};return{restrict:"AE",scope:{field:"="},compile:function(t,i,n){return function(t,i,n){r(n);var l=a(t,i,n);l.removeAttr("formula:input"),e(l)(t,function(e,t){i.replaceWith(e)})}}}}]),angular.module("formula").factory("formulaFieldset",["formulaFieldBuilder","formulaTemplateService",function(e,t){"use strict";function i(i,r){if(i&&"object"===i.type){var a=[{fields:[],active:!0,id:"the-fieldset",mainType:"@fieldset",valid:!0}];return Object.keys(i.properties).forEach(function(t){var n=i.properties[t],l=e.build({schema:n,id:t});l&&(l.setRequired(i.required),l.valueFromModel(r),a[0].fields.push(l))}),t.initNode(a[0]),a}throw"Can't create fieldsets from schema"}var r=function(i,r,a){if(i&&"object"===i.type&&r.fieldsets){var n=[];return r.fieldsets.forEach(function(r,l){var o={title:r.title,active:!l,fields:[],id:"fs"+l,mainType:"@fieldset",valid:!0};n.push(o),r.fields.forEach(function(t,r){var l="string"==typeof t?t:t.id,s=i.properties[l]||{id:l},u=n.reduce(function(e,t){return e.concat(t.fields)},[]).find(function(e){return e.id===l}),f=e.build({schema:s,id:l,fieldDefinition:t});u&&(f.value=u.value,u.values&&(f.values=u.values),u.fields&&(f.fields=u.fields)),f&&(f.setRequired(i.required),f.valueFromModel(a),o.fields.push(f))}),t.initNode(o)}),n}throw"Can't create fieldsets from schema/formDefinition"};return{fieldsetFromSchema:i,fieldsetFromDefinition:r}}]),angular.module("formula").factory("formulaForm",["$rootScope","$location","formulaJsonLoader","formulaModel","formulaI18n","formulaEvaluateConditionsService","formulaTemplateService","formulaFieldset","formulaDirtyCheckService",function(e,t,i,r,a,n,l,o,s){"use strict";function u(i,u,f,d){this.errors=null,this.schema=i,this.formDefinition=f,this.title=null,this.valid=!1,this.model=new r(u),this.mainType="@form",l.initNode(this),n.setKeepFailing(!!d);var c="en";f?(this.title=f.title,this.fieldsets=o.fieldsetFromDefinition(i,f,this.model.data),c=f.lang||c):this.fieldsets=o.fieldsetFromSchema(i,this.model.data),this.onsave=function(e){window.open("data:application/json,"+JSON.stringify(e)),this.ready=!0};var m=this;this.destroyWatcher=e.$on("revalidate",function(){m.validate()}),this.destoryDirtyChecker=e.$on("$locationChangeStart",function(e,i,r){s.isDirty()&&m.confirmDirtyNavigate&&(e.preventDefault(),m.confirmDirtyNavigate(function(){s.override();var e,r=document.head.querySelector("base");e=r?r.href.replace(/\/$/,""):location.protocol+"//"+location.host,t.path(i.replace(e,""))}))}),a.addDefaultLanguage(this,c).then(function(){m.translate()}),this.activate=this.activate.bind(this),this.validate(!0,!0)}var f=function(e){var t=[],i=function(e){t.push.apply(t,f(e))};return e.typeOf("array")?(e.items.forEach(i),e.values.forEach(i)):e.typeOf("object")&&e.fields.forEach(i),t.push(e),t};return u.prototype={updateTemplates:function(){l.initNode(this),this.fieldsets.forEach(l.initNode),this.fields().forEach(l.initNode)},updateTemplate:function(e){l.evalTemplate(this,e),this.fieldsets.forEach(function(t){l.evalTemplate(t,e)}),this.fields().forEach(function(t){l.evalTemplate(t,e)})},fields:function(){var e=[];return this.fieldsets.forEach(function(t){t.fields.forEach(function(t){e.push.apply(e,f(t))})}),e},destroy:function(){this.fields().forEach(function(e){e.destroy()}),this.destroyWatcher(),this.destoryDirtyChecker()},activate:function(t){if(this.fieldsets){var i;this.fieldsets.forEach(function(e,r){"object"!=typeof t&&"number"!=typeof t||(("object"==typeof t?e===t:r===t)?(e.active=!0,i=e):e.active=!1)}),e.$broadcast("activate:fieldset",i)}},toggleArrays:function(){this.fieldsets.forEach(function(e){e.fields.forEach(function(e){e.values.forEach(function(t,i){e.itemToggle(i)})})})},save:function(e){if(e!==!1&&!this.validate(!0))throw console.warn("Document not vaild",this.errors),this.errors;if("function"==typeof this.onsave)return this.ready=!1,this.onsave(this.model.data)},translate:function(){this.fieldsets.forEach(function(e,t){a.fieldsets&&(e.title=a.fieldsets[t]||e.title),a.fields&&e.fields.forEach(function(e){a.fields[e.id]&&e.translate(a.fields[e.id])})})},validate:function(e,t){var i=this;this.errors=[];var r=function(i,a){var n=!0;return i.typeOf("array")?i.values.forEach(function(e){r(e,a)}):i.typeOf("object")&&i.fields.forEach(function(e){r(e,a)}),(i.dirty||e)&&null==i.instance&&(i.validate(e,t)?delete a.errors[i.id]:(i.typeOf("input")&&!t&&(a.errors[i.id]=i.error),n=!1)),n};return this.valid=!0,this.fieldsets.forEach(function(e){e.valid=!0,e.errors=e.errors||{},e.fields.forEach(function(a){r(a,e)?i.model.data[a.id]=a.value:(e.valid=t||a.valid!==!1&&e.valid,i.valid=!1,delete i.model.data[a.id])}),i.errors=i.errors.concat(Object.keys(e.errors).map(function(t){return t+": "+e.errors[t]}))}),n.evaluateConditions(this),this.valid&&(this.errors=null),this.valid}},u}]),angular.module("formula").factory("formulaFormat",[function(){"use strict";return{color:function(e,t){var i="aqua,black,blue,fuchsia,gray,green,lime,maroon,navy,olive,orange,purple,red,silver,teal,white,yellow";return"string"!=typeof e||i.split(",").indexOf(e.toLowerCase())===-1&&!/^(#([a-f0-9]{3}|[a-f0-9]{6})|rgb\(\s?\d{1,3}%?,\s?\d{1,3}%?,\s?\d{1,3}%?\s?\))$/i.test(e)?"CSS 2.1 color":null},date:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}$/.test(e)?null:"ISO 8601 date, e.g. 2015-11-30 (year-month-day)"},datetime:function(e,t){return"string"==typeof e&&/^\d{4}(-\d{2}){2}T\d{2}(:\d{2}){2}(.\d+)?(([+-](\d{2}|\d{4}|\d{2}:\d{2}))|Z)$/.test(e)?null:"ISO 8601 datetime, e.g. 2015-11-30T23:45:30Z"},yearmonth:function(e,t){return"string"==typeof e&&/^\d{4}-\d{2}$/.test(e)?null:"ISO 8601 date without day fraction, e.g. 2016-01 (year-month)"},year:function(e,t){return"string"==typeof e&&/^\d{4}$/.test(e)?null:"ISO 8601 four-digit year, e.g. 2015"},email:function(e,t){var i=/^[-+a-z0-9!#$%&'*=?^_`{|}~\/]([-+a-z0-9!#$%&'*=?^_`{|}~\/]|\.(?!\.)){0,62}[-+a-z0-9!#$%&'*=?^_`{|}~\/]$/i,r=/^[-a-z0-9]([-a-z0-9]|\.(?!\.)){0,253}[-a-z0-9]$/i,a=/\(.*\)/g,n="string"==typeof e?e.split("@"):[];return 2===n.length&&e.length<=254&&i.test(n[0].replace(a,""))&&r.test(n[1].replace(a,""))?null:"RCF 3696 e-mail address"},time:function(e,t){return"string"==typeof e&&/^\d{2}(:\d{2}){2}$/.test(e)?null:"ISO 8601 time, e.g. 23:45:30"},uri:function(e,t){return"string"==typeof e&&/^([a-z][a-z0-9+.-]*):(?:\/\/((?:(?=((?:[a-z0-9-._~!$&'()*+,;=:]|%[0-9A-F]{2})*))(\3)@)?(?=(\[[0-9A-F:.]{2,}\]|(?:[a-z0-9-._~!$&'()*+,;=]|%[0-9A-F]{2})*))\5(?::(?=(\d*))\6)?)(\/(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\8)?|(\/?(?!\/)(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/]|%[0-9A-F]{2})*))\10)?)(?:\?(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\11)?(?:#(?=((?:[a-z0-9-._~!$&'()*+,;=:@\/?]|%[0-9A-F]{2})*))\12)?$/i.test(e)?null:"RFC 3986 URI"}}}]),angular.module("formula").factory("formula",["$q","formulaI18n","formulaTemplateService","formulaSchema","formulaJsonLoader","formulaForm",function(e,t,i,r,a,n){"use strict";var l=function(l){if(!l)throw"No formula options provided!";var o,s={},u=new r,f=[u.deref(l.schema),a(l.model),a(l.form)],d=function(e){t.set(e).then(function(){s.controller&&s.controller.setLanguage(e)})};l.templates instanceof Array&&i.setTemplates(l.templates);var c=(l.languages instanceof Array?l.languages:[]).map(function(e,i){return t.add(e.uri||e.map,e.code,e.aliases)});e.all(c).then(function(e){d(l.language||"en")});var m=e.all(f).then(function(e){return o=e[2],h(e[1],e[2]),e},function(){console.error("Could not load form",arguments)}),h=function(e,t){s.form&&s.form.destroy(),s.form=new n(u.json,e,t,l.keepFailing),s.controller&&(s.controller.setForm(s.form),s.form.translate()),s.form.onsave=l.onsave||s.form.onsave,s.form.confirmDirtyNavigate=l.confirmDirtyNavigate};return this.setModel=function(e){l.model=e,m.then(function(t){h(e,o)})},this.getModel=function(){return s.form?s.form.model.data:l.model},this.setForm=function(t){var i=[m];"string"==typeof t?i.push(a(t)):i.push(Promise.resolve(t)),e.all(i).then(function(e){o=e[1],h(l.model,e[1])})},this.setTemplates=function(e){e.setTemplates(e),m.then(function(e){s.form.updateTemplates()})},this.addTemplate=function(e){i.addTemplate(e),m.then(function(t){s.form.updateTemplate(e)})},this.setOnSave=function(e){l.onsave=e,s.form&&(s.form.onsave=e)},this.save=function(){return s.form.save()},this.getSchema=function(){var t=e.defer();return m.then(function(e){t.resolve(s.form.schema)}),t.promise},this.getFieldByPath=function(t){var i=e.defer();return m.then(function(e){var r=s.form.fields().find(function(e){return e.path===t});i.resolve(r)}),i.promise},this.getFields=function(){var t=e.defer();return m.then(function(e){t.resolve(s.form.fields())}),t.promise},this.i18n={add:t.add,set:d,get code(){return t.code}},this.setConfirmDirtyNavigate=function(e){l.confirmDirtyNavigate=e,s.form&&(s.form.confirmDirtyNavigate=e)},this._cfg=s,this};return{getInstance:function(e){return new l(e)}}}]),angular.module("formula").factory("formulaI18n",["formulaJsonLoader","formulaLog","$q",function(e,t,i){"use strict";var r={code:"en",text:{actions:{label:"More",tooltip:"Click for more actions"},add:{label:"Add",tooltip:"Click to add a new item"},invalid:"{count} invalid fields",moveup:{label:"Move up",tooltip:"Click to move item up"},movedown:{label:"Move down",tooltip:"Click to move item down"},maximize:{label:"Maximize",tooltip:"Click to maximize item"},minimize:{label:"Minimize",tooltip:"Click to minimize item"},remove:{label:"Remove",tooltip:"Click to remove item"},required:"required",save:{label:"Save",tooltip:"Click to save document"},validate:{label:"Validate",tooltip:"Click to validate form"},item:"Item {item}: {error}"},fields:{},fieldsets:[]},a=r,n={},l={},o={},s=function(e){var t=o[e];if(tv4.language(t.replace("_","-")),l[t])return Promise.resolve(l[t]).then(function(e){a=e,a.code=t})},u=function(e,t){e.tv4&&tv4.addLanguage(t.replace("_","-"),e.tv4)},f=function(r,a,s){if(!r)return void t.warning(t.codes.I18N_MISSING_URI);if(!a)return void t.warning(t.codes.I18N_MISSING_CODE,{uri:r});var f=i.defer();(s instanceof Array?s:[s]).forEach(function(e){o[e]=a}),o[a]=a;var d=o[a];if(l[d]=f.promise,"string"==typeof r)e(r).then(function(e){var t=n[d]||{};n[d]=angular.merge(t,e),u(n[d],d),f.resolve(n[d])});else{var c=n[d]||{};n[d]=angular.merge(c,r),u(n[d],d),f.resolve(n[d])}return f.promise},d=function(e,t){return t.forEach(function(t){e[t.id]={title:t.title||t.id,description:t.description},t.typeOf("object")&&t.fields?(e[t.id].fields={},d(e[t.id].fields,t.fields)):t.typeOf("field")&&t.items[0]?(e[t.id].items={},d(e[t.id].items,t.items)):t.typeOf("fieldset")&&t.items[0]?(e[t.id].items={title:t.items[0].title,description:t.items[0].description},t.items[0].items?(e[t.id].items.items={},d(e[t.id].items.items,t.items[0].items)):(e[t.id].items.fields={},d(e[t.id].items.fields,t.items[0].fields))):t.typeOf("select")&&t.values&&(e[t.id].values=t.values.map(function(e){return e.label}))}),e},c=function(e,t){var i=angular.merge({},{fieldsets:e.fieldsets.map(function(e){return e.title}),fields:e.fieldsets.reduce(function(e,t){return d(e,t.fields)},{}),code:t},n[t]);return f(i,t).then(function(){a.code===t&&s(t)})};return f(r,"en"),{add:f,set:s,get fields(){return a.fields},get fieldsets(){return a.fieldsets},get text(){return a.text},get code(){return a.code},addDefaultLanguage:c}}]),angular.module("formula").factory("formulaJsonLoader",["$http","$q","formulaLog",function(e,t,i){"use strict";var r;return r=function(a,n,l){var o=t.defer();return"string"!=typeof a?o.resolve(a):(n?e.jsonp(a+"?callback=JSON_CALLBACK"):e.get(a)).success(function(e,t,i,r){o.resolve(e)}).error(function(e,t,l,s){return n?(i.error(i.codes.JSON_LOAD_ERROR,{uri:a}),void o.reject(a)):r(a,!0)}),o.promise}}]),angular.module("formula").factory("formulaLog",[function(){"use strict";function e(e,t){var i=e,r=i.match(/\{[^\}]*\}/g);return angular.forEach(r,function(e,r){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}var t={FIELD_INVALID_ID:"field ID contains an illegal character: {character} ({field})",FIELD_MISSING_PROPERTY:"missing required field property: {property} ({field})",FIELD_UNSUPPORTED_FORMAT:"unsupported string format: {format} ({field})",FIELD_UNSUPPORTED_PROPERTY:"unsupported field property: {property} ({field})",FIELD_UNSUPPORTED_TOKEN:"unsupported default token: {token} ({field})",FIELD_UNSUPPORTED_TYPE:"unsupported field type: {type} ({field})",FIELD_HIDDEN_DEFAULT:"field hidden by default: {field}",I18N_MISSING_CODE:"missing language code: {uri}",I18N_MISSING_URI:"missing i18n uri",JSON_LOAD_ERROR:"could not load JSON document: {uri}",SCHEMA_INVALID_URI:"invalid URI for schema deref: {uri}",SCHEMA_MISSING_PROPERTY:"missing required schema property: {property} ({schema})",SCHEMA_MISSING_REFERENCE:"missing schema reference: {schema}",MISSING_TEMPLATE:"missing template for {missing}"};return{codes:t,debug:function(t,i){i?console.debug(e(t,i)):console.debug(t)},error:function(t,i){console.error(e(t,i))},warning:function(t,i){console.warn(e(t,i))}}}]),angular.module("formula").factory("formulaModel",[function(){"use strict";function e(e){this.data="object"==typeof e?angular.copy(e):{}}return e}]),angular.module("formula").factory("formulaSchema",["$q","formulaJsonLoader","formulaLog",function(e,t,i){"use strict";function r(e){this.deferred=null,this.json=null,this.uri=e||null}return r.cache={},r.prototype={compile:function(){function e(e){if("#"===e[0]){e=e.substr("/"===e[1]?2:1).split("/");var t=a.json;return angular.forEach(e,function(e){t&&(t=t[e])}),t}return null}function t(i,a,n){var l,o=[];return angular.forEach(i,function(s,u){"object"==typeof s?o=o.concat(t(s,i,u)):"$ref"===u&&a&&("#"===s[0]?(l=e(s))?a[n]=l:(o.push(s),delete a[n]):r.cache[s]&&r.cache[s].json?a[n]=r.cache[s].json:(o.push(s),delete a[n]))}),o}var a=this,n=this.json?t(this.json):[this.uri];return!n.length||(angular.forEach(n,function(e){i.warning(i.codes.SCHEMA_MISSING_REFERENCE,{schema:e})}),!1)},deref:function(a){var n=this;if(this.deferred=e.defer(),a&&"string"==typeof a)if(r.cache[a])r.cache[a].then(function(e){n.json=e,n.deferred.resolve(e)});else{var l={schema:r.cache[a]=new r(a),missing:null,resolve:function(e){if(e&&this.missing instanceof Array){var t=this.missing.indexOf(e);t!==-1&&this.missing.splice(t,1)}this.missing&&this.missing.length||(this.schema.compile(),n.json=this.schema.json,n.deferred.resolve(n.json))}};t(a).then(function(e){l.schema.json=e;var t=l.schema.missing(!1);t?(l.missing=angular.copy(t),angular.forEach(t,function(e){if(r.cache[e])r.cache[e].then(function(){l.resolve(e)});else{var t=new r;t.deref(e).then(function(){l.resolve(e)})}})):l.resolve()},function(e){n.deferred.reject(e)})}else i.warning(i.codes.SCHEMA_INVALID_URI,{uri:a}),this.deferred.reject("Invalid schema URI: "+a);return this},missing:function(e){function t(i){var a=[];return angular.forEach(i,function(i,n){if("object"==typeof i){var l=t(i);angular.forEach(l,function(e){a.push(e)})}else"$ref"===n&&"#"!==i[0]&&(e&&r.cache[i]||a.push(i))}),a}var i=t(this.json);return i.length?i:null},then:function(e){this.deferred?this.deferred.promise.then(function(t){e(t)},function(e){}):e(this.json)}},r}]),angular.module("formula").filter("formulaInlineValues",[function(){"use strict";return function(e,t){var i=[];return angular.forEach(e,function(e){if(e instanceof Array)i.push("Array["+e.length+"]");else switch(typeof e){case"string":case"number":case"boolean":i.push(e)}}),i.join(", ")}}]),angular.module("formula").filter("formulaReplace",[function(){"use strict";return function(e,t){var i=e;return(e.match(/\{[^\}]*\}/g)||[]).forEach(function(e){i=i.replace(e,t[e.substr(1,e.length-2)])}),i}}]),angular.module("formula").service("formulaClassService",[function(){"use strict";var e=function(e){var t=e.path;return t=t.replace("#","formula")},t=function(e){var t=e.mainType.replace("@","");return"formula"+t.charAt(0).toUpperCase()+t.slice(1)};return{schemaClass:t,pathClass:e}}]),angular.module("formula").service("formulaDirtyCheckService",[function(){"use strict";var e;return{setForm:function(t){e=t},isDirty:function(){return!!e&&e.$dirty},override:function(){e&&(e.$setPristine(),e.$setUntouched())}}}]),angular.module("formula").service("formulaEvaluateConditionsService",["$rootScope",function(e){"use strict";var t=!0,i=function(e){var t={};e.fieldsets.forEach(function(e){e.fields.forEach(function(e){t[e.id]=e.value})}),e.fields().forEach(function(e){r(e,t)})},r=function(i,r){if(i.condition){var a=!0,n=i.condition instanceof Array?i.condition:[i.condition];n.forEach(function(t){a&&("#"!==t[0]&&(t=i.path.substr(0,i.path.lastIndexOf("/")+1)+t),t=t.substr(2),t=t.replace(/\/(\d+)/g,"[$1]"),t=t.replace(/\//g,"."),t=t.replace("=","==").replace("===","=="),a=e.$eval(t,r))}),i.visible=!i.hidden&&a,t||(a?i.value=i.backupValue||i.value:(i.backupValue=i.value,i.value=void 0))}};return{evaluateConditions:i,setKeepFailing:function(e){t=e}}}]),angular.module("formula").service("formulaTemplateService",["$templateCache","$templateRequest","$q","formulaLog","formulaFieldConfig",function(e,t,i,r,a){"use strict";var n=[{match:"@field",templateUrl:"formula/default/field.html"},{match:"@object",templateUrl:"formula/default/object.html"},{match:"@array",templateUrl:"formula/default/array.html"},{match:"@fieldset",templateUrl:"formula/default/fieldset.html"},{match:"@form",templateUrl:"formula/default/form.html"}],l=a.getInstance(n),o=function(r){var a=e.get(r);if(!a)return t(r,!1);var n=i.defer();return n.resolve(a),n.promise},s=function(e,t){var r=t||l.getMatchingConfig(e),a=i.defer();return r?r.hidden||""===r.template?a.resolve(!1):r.template?a.resolve(r.template):r.templateUrl?o(r.templateUrl).then(function(e){a.resolve(e)},function(){a.reject(r.templateUrl)}):a.reject(e.path):a.reject(e.mainType),a.promise},u=function(e){e.template||s(e).then(function(t){t?e.template=t:e.hidden=!0},function(t){r.warning(r.codes.MISSING_TEMPLATE,{missing:t}),e.hidden=!0})},f=function(e){l.setConfigs(e)},d=function(e){l.addConfig(e)},c=function(e,t){l.isMatch(e,t)&&s(e,t).then(function(t){e.template=t})};return{addTemplate:d,setTemplates:f,initNode:u,evalTemplate:c}}]),angular.module("formula").run(["$templateCache",function(e){e.put("formula/default/array.html",'<fieldset ng-class="{ valid: field.valid, error: field.errors }"><legend>{{ field.title }} ({{ field.nrArrayValues() || 0 }})</legend><ul ng-if="::field.typeOf(\'fieldset\')"><li ng-repeat="value in field.values" ng-if="!value.hidden"><fieldset ng-class="{ valid: value.valid }"><legend><span ng-if="!value.visible">{{ value.value | formulaInlineValues }}</span> <a ng-show="!$first" class="toggle" href="" ng-click="field.moveUp($index)" ng-attr-title="{{ i18n.text.moveup }}">&uarr;</a> <a ng-show="!$last" class="toggle" href="" ng-click="field.moveDown($index)" ng-attr-title="{{ i18n.text.movedown }}">&darr;</a> <a class="toggle" href="" ng-click="field.itemToggle($index)" ng-attr-title="{{ value.visible ? i18n.text.minimize.tooltip : i18n.text.maximize.tooltip }}">{{ value.visible ? \'_\' : \'‾\' }}</a> <a class="remove" href="" ng-click="field.itemRemove($index)" ng-attr-title="{{ i18n.text.remove.tooltip }}">&times;</a></legend><formula:field field="value" ng-if="value.visible"></formula:field></fieldset></li></ul><ul ng-if="::field.typeOf(\'field\')"><li ng-class="{ valid: value.valid, error: value.error }" ng-repeat="value in field.values"><input formula:input="" field="value"><div class="input-ctrls"><a ng-show="!$first" class="toggle" href="" ng-click="field.moveUp($index)" ng-attr-title="{{ i18n.text.moveup }}">&uarr;</a> <a ng-show="!$last" class="toggle" href="" ng-click="field.moveDown($index)" ng-attr-title="{{ i18n.text.movedown }}">&darr;</a> <a class="remove" href="" ng-click="field.itemRemove($index)" ng-attr-title="{{ i18n.text.remove.tooltip }}">&times;</a></div><div><span ng-if="value.error">{{ value.getErrorText() }}</span> <span ng-if="value.description">{{ value.description }}</span></div></li></ul><div ng-if="field.errors" title="{{ field.errors.join(\'\\n\') }}">{{ i18n.text.invalid | formulaReplace : { count: field.errors.length } }}</div><div ng-if="!field.errors">{{ field.description }}</div><div class="formulaArrayCtrls"><button class="add" ng-click="field.itemAdd()" title="{{ i18n.text.add.tooltip }}" type="button"><strong>&plus;</strong> {{ i18n.text.add.label }}</button></div></fieldset>'),e.put("formula/default/field.html",'<div ng-class="{ valid: field.valid, error: field.error, required: (field.required && field.value == null) }" ng-if="field.visible" title="{{ field.description }}"><label for="{{ ::field.uid }}">{{ field.title }} {{field.visibility}}</label><formula:input field="field"></formula:input><span ng-if="field.error">{{ field.getErrorText() }}</span> <span ng-if="field.description">{{ field.description }}</span></div>'),e.put("formula/default/fieldset.html",'<fieldset ng-show="fieldset.active"><formula:fields fields="::fieldset.fields"></formula:fields></fieldset>'),e.put("formula/default/form.html",'<div><div class="formula" ng-if="!form.ready"><div class="loading"><div class="spinner"></div><span>Loading...</span></div></div><form class="formula" ng-show="form.ready"><header ng-if="::form.title">{{ form.title }}</header><nav ng-if="::form.fieldsets.length > 1"><a href="" ng-class="{ active: fieldset.active, error: !fieldset.valid }" ng-click="form.activate(fieldset)" ng-repeat="fieldset in ::form.fieldsets track by fieldset.id">{{ fieldset.title }}</a></nav><formula:fieldsets></formula:fieldsets><footer><span ng-if="form.errors" title="{{ form.errors.join(\'\\n\') }}">{{ i18n.text.invalid | formulaReplace : { count: form.errors.length } }}</span> <button ng-click="form.validate(true);" ng-if="!data.hideButtons" title="{{ i18n.text.validate.tooltip }}"><strong>&#10003;</strong> {{ i18n.text.validate.label }}</button> <button ng-click="form.save()" ng-disabled="!form.valid" ng-if="!data.hideButtons" title="{{ i18n.text.save.tooltip }}"><strong>&#9921;</strong> {{ i18n.text.save.label }}</button></footer></form></div>'),e.put("formula/default/object.html",'<fieldset><legend ng-if="::field.title">{{ field.title }}</legend><formula:fields fields="::field.fields"></formula:fields></fieldset>')}]),angular.module("formula").factory("formulaArrayField",["$rootScope","formulaField","formulaI18n","formulaArrayFieldTypeService","formulaTemplateService",function(e,t,i,r,a){"use strict";var n=function(e){void 0!==e["default"]?(e["default"]instanceof Array||(e["default"]=[e["default"]]),e.value=e["default"]):e.value=[]},l={create:function(e){var i=t.create(e);if(angular.extend(i,l.prototype),r.applyType(i),i.type)return i.values=[],n(i),i.setItemProto(),i.schema.minItems&&i.itemAdd(),a.initNode(i),i.visible=!i.hidden,i}},o=function(e,t){return e+(t.hidden?0:1)};return l.prototype={setItemProto:function(){var e,i=this.parents.slice();i.push(this),this.items||(this.items=[]);var r=/\/([^\/]*?)$/.exec(this.path)[1]+"_item",a=this.fieldDefinition.items||{};a.id=r;var n=this.schema.items;return e=t.builder.build({schema:n,id:r,parents:i,fieldDefinition:a}),!!e&&(e.setRequired(this.schema.required),e.index=this.items.length,this.items.push(e),!0)},itemAdd:function(i){if(this.items){var r=this.parents.slice();r.push(this);var a=this.values.length,n=this.items[0],l=t.builder.build({schema:n.schema,id:n.id,parents:r,fieldDefinition:n.fieldDefinition,index:a});return l.type?(this.values.push(l),void 0!==l.value&&this.value.push(l.value),this.dirty=!0,this.updateParent(),i!==!0&&e.$emit("revalidate"),this.fieldTranslations&&l.translate(this.fieldTranslations),l):null}return null},itemRemove:function(t){var i;return this.values.length>t&&(i=this.values.splice(t,1)[0],this.value.splice(t,1)),this.values.forEach(function(e,t){e.index=t}),"function"==typeof t.destroyWatcher&&t.destroyWatcher(),this.dirty=!0,this.updateParent(),e.$emit("revalidate"),i},moveUp:function(e){var t=this.values[e],i=this.values[e-1];t.index=e-1,i.index=e,this.values[e-1]=t,this.values[e]=i,this.itemChange()},moveDown:function(e){var t=this.values[e],i=this.values[e+1];t.index=e+1,i.index=e,this.values[e+1]=t,this.values[e]=i,this.itemChange()},itemChange:function(e){this.value.length=0,this.values.forEach(function(e){void 0!==e.value&&this.value.push(e.value)},this),this.dirty=!0,this.updateParent()},itemToggle:function(e){this.values.length>e&&(this.values[e].visible=!this.values[e].visible)},destroy:function(){this.values.forEach(function(e){e.destroy()})},valueFromModel:function(e,i){var r=angular.copy(e);void 0!==r[this.id]&&(this.values.forEach(function(e){e.destroy()}),this.values.length=0,r[this.id].forEach(function(e,t){var i=this.itemAdd(!0);if(i){this.typeOf("fieldset")&&0!==i.index&&(i.visible=!1);var r={};r[this.values[t].id]=e,this.values[t].valueFromModel(r)}},this),t.prototype.valueFromModel.call(this,r,i))},translate:function(e){e&&(this.fieldTranslations=e.items,Object.keys(e.items||{}).forEach(function(t,i){this.items.concat(this.values).forEach(function(t){t.translate(e.items)},this)},this),t.prototype.translate.call(this,e))},nrArrayValues:function(){return this.values?this.values.reduce(o,0):0}},l}]),angular.module("formula").factory("formulaField",["$q","$filter","$rootScope","formulaLog","formulaI18n","formulaTemplateService","formulaFieldValidateService",function(e,t,i,r,a,n,l){"use strict";var o,s=1,u=function(e){[".","/","#"].forEach(function(e){this.id&&this.id.indexOf(e)>=0&&r.warning(r.codes.FIELD_INVALID_ID,{character:e,field:this.path})},e)},f=function(e,t){if("object"==typeof e){var i="condition,default,description,disabled,enum,format,hidden,instance,maximum,maxLength,minimum,minLength,multiple,nullable,pattern,readonly,required,step,title,type,values".split(",");angular.forEach(t,function(e,t){i.indexOf(t)!==-1&&(this[t]=e)},e)}},d=function(e){e.type instanceof Array&&(e.nullable=e.type.some(function(e){return"null"===e}),1===e.type.length?e.type=e.type[0]:2===e.type.length?"null"===e.type[0]?e.type=e.type[1]:"null"===e.type[1]&&(e.type=e.type[0]):(e.types=e.type,e.type="any"))},c=function(e){var t="formula-"+("00000"+(s++).toString(16)).slice(-5);return e.uid=t},m={create:function(t){var i=Object.create(m.prototype);return i.parents=t.parents||[],i.id=t.id,i.title=t.id.replace(/_/g," "),i.index=t.index,i._elem_q=e.defer(),f(i,i.schema=t.schema),f(i,i.fieldDefinition=t.fieldDefinition||{}),u(i),c(i),d(i),i},fieldBuilder:o};return m.prototype={get element(){return this._elem_q.promise},get path(){var e="#",t=function(e){var t="/";return t+=null!=e.index?e.index:e.id};return this.parents.forEach(function(i){e+=t(i)}),e+=t(this)},typeOf:function(e){if(!this.type||"string"!=typeof this.type)return!1;var t;return e===this.type||e===(t=this.type.split(":"))[0]||e===t[1]},isEmpty:function(){return null==this.value||0===this.value.length},validate:function(e,t){return l.validate(this,{force:e,silent:t})},valueFromModel:function(e,t){void 0!==e[this.id]&&this.value!==e[this.id]&&(this.value=e[this.id],this.dirty=!0,this.updateParent(),n.initNode(this),t&&i.$emit("revalidate"))},setRequired:function(e){this.required=e===!0||e instanceof Array&&e.indexOf(this.id)!==-1},translate:function(e){this.title=e.title||this.title,this.description=e.description||this.description},getErrorText:function(e){var i="";if(e=e||this.error,!e)return i;if(e.dataPath){var r=Number(e.dataPath.replace(/^\/(\d+).*$/,"$1"))+1;i+=t("formulaReplace")(a.text.item,{item:r,error:e.message})}else i+=e.message;return i},destroy:function(){"function"==typeof this.destroyWatcher&&this.destroyWatcher()},updateParent:function(){var e;(e=this.parents[this.parents.length-1])&&e.itemChange(this)}},m}]),angular.module("formula").factory("formulaFieldConfig",[function(){"use strict";var e=function(e){var t=e||[],i=function(e,t){var i=!1;if(t.match)if("function"==typeof t.match)try{t.match.call({},e)&&(i=!0)}catch(r){}else"string"==typeof t.match&&[e.mainType,e.id,e.path].indexOf(t.match)!==-1&&(i=!0);return i};this.getMatchingConfig=function(e){for(var r,a=t.length-1,n=a;n>=0;n--)if(i(e,t[n])){r=t[n];break}return r},this.addConfig=function(e){t.push(e)},this.setConfigs=function(e){t=e},this.isMatch=function(e,t){return i(e,t)}};return{getInstance:function(t){return new e(t)}}}]),angular.module("formula").factory("formulaInputField",["$rootScope","formulaLog","formulaField","formulaFieldTranslateDefaultsService","formulaInputFieldTypeService","formulaTemplateService",function(e,t,i,r,a,n){"use strict";var l=function(e){void 0!==e["default"]?e.value=e["default"]:e.typeOf("select")&&!e.multiple&&(e.value=e["enum"][0])},o=function(t){t.destroyWatcher=e.$watch(function(){return t.value},function(i,r){if(!angular.equals(i,r)){if(null===t.value||""===t.value)return void(t.value=void 0);t.dirty=!0,t.updateParent(),e.$emit("revalidate")}})},s={create:function(e){
var u=i.create(e);if(angular.extend(u,s.prototype),a.applyType(u),u.type)return r.translateDefaultValues(u),l(u),u.pattern&&!u.schema.pattern&&(u.schema.pattern=u.pattern),u.id&&"_"===u.id[0]&&u.hidden!==!1&&(t.debug(t.codes.FIELD_HIDDEN_DEFAULT,{field:u.path}),u.hidden=!0),n.initNode(u),u.visible=!u.hidden,o(u),u}};return s.prototype={translate:function(e){this.typeOf("select")&&e.values&&this.values.forEach(function(t,i){t.label=e.values[i]||t.label},this),i.prototype.translate.call(this,e)}},s}]),angular.module("formula").factory("formulaObjectField",["formulaLog","formulaField","formulaTemplateService",function(e,t,i){"use strict";var r=function(e){void 0!==e["default"]?e.value=e["default"]:e.value={}},a=function(t){t.mainType="@object",t.schema.properties||(e.warning(e.codes.FIELD_MISSING_PROPERTY,{property:"properties",field:t.path}),t.type=null)},n={create:function(e){var l=t.create(e);if(angular.extend(l,n.prototype),a(l),l.type)return r(l),l.fieldAdd(),i.initNode(l),l.visible=!l.hidden,l}},l=function(e){return"string"==typeof e&&"!"===e.charAt(0)};return n.prototype={fieldAdd:function(){var e=this.parents.slice();e.push(this),this.fields||(this.fields=[]),Object.keys(this.schema.properties).forEach(function(i){var r,a=this.schema.properties[i];if(this.fieldDefinition.fields&&this.fieldDefinition.fields.forEach(function(e){var t;t="string"==typeof e?e.replace("!",""):e.id,i===t&&(r=e)}),!l(r)){var n=t.builder.build({schema:a,id:i,parents:e,fieldDefinition:r});n&&(n.setRequired(this.schema.required),this.fields.push(n))}},this)},itemChange:function(e){this.fields&&this.fields.forEach(function(e){void 0!==e.value&&(this.value[e.id]=e.value)},this),this.dirty=!0,this.updateParent()},valueFromModel:function(e,i){void 0!==e[this.id]&&(this.fields.forEach(function(t,i){void 0!==e[this.id][t.id]&&t.valueFromModel(e[this.id])},this),t.prototype.valueFromModel.call(this,e,i))},translate:function(e){e&&(e.fields&&this.fields.forEach(function(t){e.fields[t.id]&&t.translate(e.fields[t.id])}),t.prototype.translate.call(this,e))}},n}]),angular.module("formula").service("formulaArrayFieldTypeService",["$filter","formulaLog","formulaFormat",function(e,t,i){"use strict";var r=function(e){if(e.mainType="@array",e.values=[],e.schema.items){var i=e.schema.items;"object"===i.type||"array"===i.type?e.type="array:fieldset":i.allOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"allOf",field:e.path}):i.anyOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"anyOf",field:e.path}):i.oneOf?t.warning(t.codes.FIELD_UNSUPPORTED_PROPERTY,{property:"oneOf",field:e.path}):e.type="array:field",e.schema.minItems>=1&&(e.required=!0)}else t.warning(t.codes.FIELD_MISSING_PROPERTY,{property:"items",field:e.path}),e.type=null};return{applyType:r}}]),angular.module("formula").service("formulaFieldBuilder",["formulaField","formulaInputField","formulaObjectField","formulaArrayField",function(e,t,i,r){"use strict";var a=function(e,t){return e instanceof Array?e.indexOf(t)!==-1:e===t},n=function(e){return e.items&&e.items["enum"]};return{build:function(l){var o=l.schema;if(e.builder=this,"object"==typeof o){var s;return s=a(o.type,"object")?i.create(l):a(o.type,"array")&&!n(o)?r.create(l):t.create(l)}}}}]),angular.module("formula").service("formulaFieldTranslateDefaultsService",["$filter","formulaLog",function(e,t){"use strict";var i=function(i){if("string"==typeof i["default"]){var r,a=i["default"].match(/^%(.*)%$/);if(a){switch(a[1]){case"date":r=e("date")(new Date,"yyyy-MM-dd","UTC");break;case"datetime":r=e("date")(new Date,"yyyy-MM-ddThh:mm:ss","UTC")+"Z";break;case"time":r=e("date")(new Date,"hh:mm:ss","UTC");break;case"year":r=e("date")(new Date,"yyyy","UTC");break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TOKEN,{token:a[1],field:i.path})}r&&(i["default"]=r)}}};return{translateDefaultValues:i}}]),angular.module("formula").service("formulaFieldValidateService",[function(){"use strict";var e=function(e,t){var i=t.silent,r=t.force;if(e.schema){var a;if(!e.dirty&&!r||!e.required&&void 0===e.value||(a=tv4.validateMultiple(e.value,e.schema),e.valid=a.valid),!e.valid&&e.nullable){switch(typeof e.value){case"string":e.value&&e.value.length||(e.value=null);break;case"number":isNaN(e.value)&&(e.value=null);break;case"object":e.typeOf("object")&&!Object.keys(e.value).length&&(e.value=null)}e.typeOf("array")&&e.values&&!e.values.length&&(e.value=null),e.isEmpty()&&(e.valid=!0)}return!i&&a&&e.valid===!1?e.typeOf("array")||e.typeOf("object")?e.errors=a.errors:e.error=a.errors[0]:(e.error=null,e.errors=null),e.dirty=!1,e.valid!==!1}return!1};return{validate:e}}]),angular.module("formula").service("formulaInputFieldTypeService",["$filter","formulaLog","formulaFormat",function(e,t,i){"use strict";var r=function(e){e["enum"]=e.schema.items["enum"],e.multiple=!0,e.schema.minItems>=1&&(e.required=!0)},a=function(e){e.values=[],e["enum"].forEach(function(t){e.values.push({id:t,label:t})})},n=function(e){e.mainType="@field";var n="input:text";if(e.schema.items&&e.schema.items["enum"]&&r(e),"select"===e.type||e["enum"])n="input:select",a(e);else if(e.format){var l=e.format.replace("-","");i[l]?(tv4.addFormat(e.format,i[l]),["date","datetime","time"].indexOf(l)!==-1&&(n="input:"+l)):t.warning(t.codes.FIELD_UNSUPPORTED_FORMAT,{format:e.format,field:e.path})}else switch(e.type){case"any":n="input:any";break;case"boolean":n="input:checkbox",e.value=!!e.value;break;case"integer":case"number":n="input:number";break;case"range":n="input:range";break;case"textarea":n="input:textarea";break;case"string":case"text":n="input:text";break;case void 0:n="input:text";break;default:t.warning(t.codes.FIELD_UNSUPPORTED_TYPE,{type:e.type,field:e.path}),n=null}e.type=n};return{applyType:n}}]);